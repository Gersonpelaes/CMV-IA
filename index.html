<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cmv IA - Dashboard de Gestão Responsivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bibliotecas para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Link para o Manifest do PWA -->
    <link rel="manifest" href="manifest.json">
    
    <style>
        :root {
            --bg-primary: #f3f4f6;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --form-bg: #f9fafb;
            --form-border: #d1d5db;
        }

        .dark-theme {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-card: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
            --form-bg: #374151;
            --form-border: #4b5563;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .view { display: none; }
        .view.active { display: block; }

        .sidebar {
            background-color: var(--bg-secondary);
            transition: transform 0.3s ease-in-out;
        }

        .main-content {
            transition: margin-left 0.3s ease;
        }

        .card {
            background-color: var(--bg-card);
            border-color: var(--border-color);
            border-width: 1px;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: box-shadow 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        .btn-primary {
            background-color: #2563eb; /* Azul 600 */
            color: white;
            font-weight: 600;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #1d4ed8; /* Azul 700 */
        }
        
        .btn-secondary {
            background-color: var(--border-color);
            color: var(--text-primary);
            font-weight: 600;
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .form-input, .form-select {
            background-color: var(--form-bg);
            border: 1px solid var(--form-border);
            color: var(--text-primary);
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
        }
        .form-input:focus, .form-select:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #2563eb; /* Azul 600 */
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.5);
        }

        .table-header {
            background-color: var(--form-bg);
        }

        .table-row:nth-child(even) {
            background-color: var(--form-bg);
        }
        
        .loader { border: 4px solid #e5e7eb; border-top: 4px solid #2563eb; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .mic-active { color: #ef4444; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: #2563eb; }
        input:checked + .slider:before { transform: translateX(26px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        /* Forçar texto em maiúsculas */
        #nome-cat-ingrediente, #nome-cat-prato, #nome-cat-base, #nome-cat-venda,
        #nome-ingrediente, #descricao-produto, #modo-preparo, #nome-produto-venda {
            text-transform: uppercase;
        }

    </style>
</head>
<body class="bg-primary text-primary">

    <!-- Auth View -->
    <div id="auth-view" class="flex items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900">
        <div class="w-full max-w-md">
            <div class="card p-8">
                <div class="text-center mb-8">
                    <svg class="w-20 h-20 mx-auto text-blue-600" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4.5 3.75a3 3 0 00-3 3v.75h21v-.75a3 3 0 00-3-3h-15z" clip-rule="evenodd"/><path d="M22.5 9.75h-21v7.5a3 3 0 003 3h15a3 3 0 003-3v-7.5zm-18.75 3.75a.75.75 0 01.75-.75h6a.75.75 0 010 1.5h-6a.75.75 0 01-.75-.75zm.75 2.25a.75.75 0 000 1.5h3a.75.75 0 000-1.5h-3z"/></svg>
                    <h1 class="text-3xl font-bold text-primary mt-2">Cmv.ia</h1>
                </div>
                <!-- Login Form -->
                <form id="login-form" class="space-y-6">
                    <div><label for="login-email" class="block text-sm font-medium text-secondary">Email</label><input type="email" id="login-email" required class="mt-1 form-input"></div>
                    <div><label for="login-password" class="block text-sm font-medium text-secondary">Palavra-passe</label><input type="password" id="login-password" required class="mt-1 form-input"></div>
                    <p id="login-error" class="text-red-500 text-sm hidden"></p>
                    <div><button type="submit" class="w-full btn-primary flex justify-center items-center">
                        <span class="btn-text">Entrar</span>
                        <span class="loader hidden ml-2"></span>
                    </button></div>
                    <p class="text-center text-sm text-secondary">Não tem uma conta? <a href="#" id="show-register" class="font-medium text-blue-600 hover:text-blue-500">Registe-se</a></p>
                </form>
                <!-- Register Form -->
                <form id="register-form" class="space-y-6 hidden">
                     <div><label for="register-restaurant" class="block text-sm font-medium text-secondary">Nome do Restaurante</label><input type="text" id="register-restaurant" required class="mt-1 form-input"></div>
                    <div><label for="register-email" class="block text-sm font-medium text-secondary">Email</label><input type="email" id="register-email" required class="mt-1 form-input"></div>
                    <div><label for="register-password" class="block text-sm font-medium text-secondary">Palavra-passe</label><input type="password" id="register-password" required class="mt-1 form-input"></div>
                     <p id="register-error" class="text-red-500 text-sm hidden"></p>
                    <div><button type="submit" class="w-full btn-primary flex justify-center items-center">
                        <span class="btn-text">Criar Conta</span>
                        <span class="loader hidden ml-2"></span>
                    </button></div>
                    <p class="text-center text-sm text-secondary">Já tem uma conta? <a href="#" id="show-login" class="font-medium text-blue-600 hover:text-blue-500">Faça login</a></p>
                </form>
            </div>
        </div>
    </div>

    <div id="app-container" class="relative min-h-screen md:flex hidden">
        <!-- Overlay para menu mobile -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>

        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar w-64 flex-shrink-0 shadow-lg fixed inset-y-0 left-0 z-30 transform -translate-x-full md:relative md:translate-x-0">
            <div class="p-6 text-center">
                 <svg class="w-20 h-20 mx-auto text-blue-600" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M4.5 3.75a3 3 0 00-3 3v.75h21v-.75a3 3 0 00-3-3h-15z" clip-rule="evenodd"/><path d="M22.5 9.75h-21v7.5a3 3 0 003 3h15a3 3 0 003-3v-7.5zm-18.75 3.75a.75.75 0 01.75-.75h6a.75.75 0 010 1.5h-6a.75.75 0 01-.75-.75zm.75 2.25a.75.75 0 000 1.5h3a.75.75 0 000-1.5h-3z"/>
                </svg>
                <h1 class="text-2xl font-bold mt-2">Cmv.ia</h1>
                <p class="text-sm text-secondary">Gestão Inteligente</p>
            </div>
            <nav class="mt-6">
                <a href="#" data-view="dashboard" class="sidebar-link flex items-center py-3 px-6 text-secondary hover:bg-blue-50 hover:text-blue-600">
                    <svg class="w-6 h-6 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                    <span>Dashboard</span>
                </a>
                <a href="#" data-view="ingredientes" class="sidebar-link flex items-center py-3 px-6 text-secondary hover:bg-blue-50 hover:text-blue-600">
                    <svg class="w-6 h-6 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                    <span>Ingredientes</span>
                </a>
                 <a href="#" data-view="venda-direta" class="sidebar-link flex items-center py-3 px-6 text-secondary hover:bg-blue-50 hover:text-blue-600">
                    <svg class="w-6 h-6 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span>Produtos de Venda</span>
                </a>
                <a href="#" data-view="fichas" class="sidebar-link flex items-center py-3 px-6 text-secondary hover:bg-blue-50 hover:text-blue-600">
                    <svg class="w-6 h-6 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                    <span>Nova Ficha</span>
                </a>
                <a href="#" data-view="consultar" class="sidebar-link flex items-center py-3 px-6 text-secondary hover:bg-blue-50 hover:text-blue-600">
                    <svg class="w-6 h-6 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <span>Consultar Fichas</span>
                </a>
                 <a href="#" data-view="precos" class="sidebar-link flex items-center py-3 px-6 text-secondary hover:bg-blue-50 hover:text-blue-600">
                    <svg class="w-6 h-6 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6a2 2 0 100-4 2 2 0 000 4zm0 12a2 2 0 100-4 2 2 0 000 4z"></path></svg>
                    <span>Preços de Venda</span>
                </a>
                <hr class="my-4 border-border-color">
                <p class="px-6 text-xs font-semibold text-gray-400 uppercase">Análises</p>
                 <a href="#" data-view="analise" class="sidebar-link flex items-center py-3 px-6 text-secondary hover:bg-blue-50 hover:text-blue-600">
                    <svg class="w-6 h-6 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    <span>Análise de Custos</span>
                </a>
                 <a href="#" data-view="margem" class="sidebar-link flex items-center py-3 px-6 text-secondary hover:bg-blue-50 hover:text-blue-600">
                    <svg class="w-6 h-6 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                    <span>Relatório de Margens</span>
                </a>
                 <a href="#" data-view="vendas" class="sidebar-link flex items-center py-3 px-6 text-secondary hover:bg-blue-50 hover:text-blue-600">
                    <svg class="w-6 h-6 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    <span>Análise de Vendas</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <div class="main-content flex-1 md:ml-64">
             <div class="p-4 md:p-8">
                <header class="flex justify-between items-center mb-8">
                    <!-- Botão Hamburger para mobile -->
                    <button id="hamburger-btn" class="md:hidden text-secondary hover:text-primary focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h2 id="header-subtitle" class="text-xl md:text-3xl font-bold">Dashboard</h2>
                    <div class="flex items-center gap-4">
                        <button data-view="settings" class="text-secondary hover:text-blue-600" title="Configurações">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </button>
                        <span id="user-email" class="hidden sm:block text-secondary"></span>
                        <button id="logout-btn" class="text-secondary hover:text-red-500" title="Sair">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        </button>
                    </div>
                </header>

                <!-- Painel de Navegação (Dashboard) -->
                <main id="dashboard-view" class="view active">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div data-view="ingredientes" class="card p-6 flex items-center gap-6 cursor-pointer">
                            <div class="bg-blue-100 p-4 rounded-full"><svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg></div>
                            <div><h3 class="text-xl font-bold">Ingredientes</h3><p class="text-secondary">Gerenciar matéria-prima</p></div>
                        </div>
                        <div data-view="fichas" class="card p-6 flex items-center gap-6 cursor-pointer">
                            <div class="bg-blue-100 p-4 rounded-full"><svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg></div>
                            <div><h3 class="text-xl font-bold">Nova Ficha</h3><p class="text-secondary">Criar receitas e pratos</p></div>
                        </div>
                         <div data-view="consultar" class="card p-6 flex items-center gap-6 cursor-pointer">
                            <div class="bg-blue-100 p-4 rounded-full"><svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div>
                            <div><h3 class="text-xl font-bold">Consultar Fichas</h3><p class="text-secondary">Ver, editar e exportar</p></div>
                        </div>
                        <div data-view="vendas" class="card p-6 flex items-center gap-6 cursor-pointer md:col-span-2 lg:col-span-3 bg-blue-600 text-white hover:bg-blue-700">
                            <div class="bg-blue-500 p-4 rounded-full"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg></div>
                            <div><h3 class="text-xl font-bold">Análise de Vendas e CMV</h3><p class="text-blue-200">Importar vendas e gerar relatórios estratégicos</p></div>
                        </div>
                    </div>
                </main>

                <!-- View de Configurações -->
                <div id="settings-view" class="view">
                    <div class="card p-4 md:p-8">
                        <div class="flex justify-between items-center mb-6 border-b border-border-color pb-4">
                            <h3 class="text-2xl font-bold">Configurações</h3>
                            <button data-view="dashboard" class="btn-secondary text-sm">Voltar</button>
                        </div>
                        
                        <div class="space-y-8">
                             <!-- Configurações Gerais -->
                            <div>
                                <h4 class="text-xl font-semibold mb-4 text-blue-700">Gerais</h4>
                                <div class="space-y-4">
                                    <div class="flex items-center justify-between bg-form-bg p-4 rounded-lg">
                                        <span class="font-medium">Tema (Claro/Escuro)</span>
                                        <label class="switch">
                                            <input type="checkbox" id="theme-toggle">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                    <div class="flex items-center justify-between bg-form-bg p-4 rounded-lg">
                                        <span class="font-medium">Habilitar Microfone (Ditado)</span>
                                        <label class="switch">
                                            <input type="checkbox" id="mic-toggle" checked>
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <!-- Gestão de Categorias -->
                            <div>
                                <h4 class="text-xl font-semibold mb-4 text-blue-700">Categorias</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                                    <div>
                                        <h5 class="text-lg font-semibold mb-3">Ingredientes</h5>
                                        <form id="form-cat-ingrediente" class="flex gap-2 mb-4">
                                            <input type="text" id="nome-cat-ingrediente" placeholder="Ex: Laticínios" required class="form-input">
                                            <button type="submit" class="btn-primary text-sm px-4">Add</button>
                                        </form>
                                        <ul id="lista-cat-ingredientes" class="space-y-2 text-sm"></ul>
                                    </div>
                                    <div>
                                        <h5 class="text-lg font-semibold mb-3">Produtos de Venda</h5>
                                        <form id="form-cat-venda" class="flex gap-2 mb-4">
                                            <input type="text" id="nome-cat-venda" placeholder="Ex: Bebidas" required class="form-input">
                                            <button type="submit" class="btn-primary text-sm px-4 bg-orange-500 hover:bg-orange-600">Add</button>
                                        </form>
                                        <ul id="lista-cat-venda" class="space-y-2 text-sm"></ul>
                                    </div>
                                    <div>
                                        <h5 class="text-lg font-semibold mb-3">Pratos Finais</h5>
                                        <form id="form-cat-prato" class="flex gap-2 mb-4">
                                            <input type="text" id="nome-cat-prato" placeholder="Ex: Prato Principal" required class="form-input">
                                            <button type="submit" class="btn-primary text-sm px-4 bg-green-600 hover:bg-green-700">Add</button>
                                        </form>
                                        <ul id="lista-cat-pratos" class="space-y-2 text-sm"></ul>
                                    </div>
                                    <div>
                                        <h5 class="text-lg font-semibold mb-3">Receitas Base</h5>
                                        <form id="form-cat-base" class="flex gap-2 mb-4">
                                            <input type="text" id="nome-cat-base" placeholder="Ex: Molhos" required class="form-input">
                                            <button type="submit" class="btn-primary text-sm px-4 bg-purple-600 hover:bg-purple-700">Add</button>
                                        </form>
                                        <ul id="lista-cat-bases" class="space-y-2 text-sm"></ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- View de Ingredientes -->
                <div id="ingredientes-view" class="view">
                    <div class="card p-4 md:p-8">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b border-border-color pb-4 gap-4">
                            <h3 class="text-2xl font-bold">Banco de Ingredientes</h3>
                            <div class="flex gap-2 flex-wrap">
                                <button type="button" id="btn-importar-ingredientes" class="btn-secondary text-sm">Importar</button>
                                <button type="button" id="btn-abrir-atualizar-precos" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">Atualizar Preços</button>
                            </div>
                        </div>
                        <div id="painel-atualizar-precos" class="hidden mb-6 bg-form-bg p-4 rounded-lg border border-border-color">
                            <h3 class="text-lg font-semibold mb-3 text-yellow-700">Atualizar Preços de Compra</h3>
                            <form id="form-atualizar-precos" class="space-y-2 max-h-64 overflow-y-auto pr-2"></form>
                            <div class="flex gap-2 mt-4">
                                <button type="button" id="btn-cancelar-atualizacao" class="flex-1 btn-secondary">Cancelar</button>
                                <button type="button" id="btn-salvar-novos-precos" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex justify-center items-center">
                                    <span class="btn-text">Salvar</span>
                                    <span class="loader hidden ml-2"></span>
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-1">
                                 <form id="form-ingrediente" class="space-y-4">
                                    <h3 class="text-xl font-semibold">Novo Ingrediente</h3>
                                    <div><label for="nome-ingrediente" class="block text-sm font-medium text-secondary">Nome</label><input type="text" id="nome-ingrediente" placeholder="Ex: Farinha de Trigo" required class="mt-1 form-input"></div>
                                    <div><label for="categoria-ingrediente" class="block text-sm font-medium text-secondary">Categoria</label><select id="categoria-ingrediente" required class="mt-1 form-select"></select></div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label for="preco-compra" class="block text-sm font-medium text-secondary">Preço Compra (R$)</label><input type="number" step="0.01" id="preco-compra" placeholder="20.00" required class="mt-1 form-input"></div>
                                        <div><label for="unidade-compra-desc" class="block text-sm font-medium text-secondary">Embalagem</label><input type="text" id="unidade-compra-desc" placeholder="Ex: Saco" required class="mt-1 form-input"></div>
                                    </div>
                                    <div class="grid grid-cols-3 gap-4">
                                        <div><label for="unidade-compra-qtd" class="block text-sm font-medium text-secondary">Volume</label><input type="number" step="0.001" id="unidade-compra-qtd" placeholder="5" required class="mt-1 form-input"></div>
                                        <div><label for="unidade-base" class="block text-sm font-medium text-secondary">Un. Base</label><input type="text" id="unidade-base" placeholder="kg" required class="mt-1 form-input"></div>
                                        <div><label for="rendimento-ingrediente" class="block text-sm font-medium text-secondary">Rend. (%)</label><input type="number" step="1" id="rendimento-ingrediente" value="100" min="1" max="100" required class="mt-1 form-input"></div>
                                    </div>
                                    <button type="submit" class="w-full btn-primary">Salvar Ingrediente</button>
                                </form>
                            </div>
                            <div class="lg:col-span-2">
                                 <h3 class="text-xl font-semibold mb-4">Ingredientes Cadastrados</h3>
                                 <div class="flex flex-col md:flex-row gap-4 mb-4">
                                    <input type="text" id="search-ingrediente" class="form-input flex-grow" placeholder="Buscar ingrediente...">
                                    <select id="filter-ingrediente-categoria" class="form-select md:w-1/3"></select>
                                 </div>
                                 <div class="overflow-x-auto">
                                    <div id="lista-ingredientes" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>

                 <!-- View de Produtos de Venda Direta -->
                <div id="venda-direta-view" class="view">
                    <div class="card p-4 md:p-8">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b border-border-color pb-4 gap-4">
                            <h3 class="text-2xl font-bold">Produtos de Venda Direta</h3>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-1">
                                 <form id="form-produto-venda" class="space-y-4">
                                    <h3 class="text-xl font-semibold">Novo Produto</h3>
                                    <div><label for="nome-produto-venda" class="block text-sm font-medium text-secondary">Nome do Produto</label><input type="text" id="nome-produto-venda" placeholder="Ex: COCA-COLA LATA" required class="mt-1 form-input"></div>
                                    <div><label for="categoria-produto-venda" class="block text-sm font-medium text-secondary">Categoria</label><select id="categoria-produto-venda" required class="mt-1 form-select"></select></div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label for="preco-compra-venda" class="block text-sm font-medium text-secondary">Preço Compra (R$)</label><input type="number" step="0.01" id="preco-compra-venda" placeholder="2.50" required class="mt-1 form-input"></div>
                                        <div><label for="preco-venda-venda" class="block text-sm font-medium text-secondary">Preço Venda (R$)</label><input type="number" step="0.01" id="preco-venda-venda" placeholder="5.00" required class="mt-1 form-input"></div>
                                    </div>
                                    <div><label for="taxa-perda-venda" class="block text-sm font-medium text-secondary">Taxa de Perda (%)</label><input type="number" step="0.1" id="taxa-perda-venda" value="0" class="mt-1 form-input"></div>
                                    <button type="submit" class="w-full btn-primary">Salvar Produto</button>
                                </form>
                            </div>
                            <div class="lg:col-span-2">
                                 <h3 class="text-xl font-semibold mb-4">Produtos Cadastrados</h3>
                                 <div id="lista-produtos-venda" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- View de Fichas Técnicas -->
                <div id="fichas-view" class="view">
                    <div class="card p-4 md:p-8">
                         <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b border-border-color pb-4 gap-4">
                            <h3 class="text-2xl font-bold">Ficha Técnica Gerencial</h3>
                            <button type="button" id="btn-nova-ficha" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">Limpar Ficha</button>
                        </div>
                        <form id="form-ficha-header" class="mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="lg:col-span-2"><label for="descricao-produto" class="block text-sm font-medium text-secondary">Descrição do Produto</label><input type="text" id="descricao-produto" placeholder="Ex: Espeto Baiano" class="mt-1 form-input"></div>
                                <div><label for="categoria-produto" class="block text-sm font-medium text-secondary">Categoria</label><select id="categoria-produto" class="mt-1 form-select"></select></div>
                                <div class="lg:col-span-4">
                                    <label class="block text-sm font-medium text-secondary">Foto do Prato</label>
                                    <div class="mt-1 flex items-center gap-4">
                                        <img id="foto-preview" src="https://placehold.co/100x100/e0e7ff/4338ca?text=Foto" class="w-24 h-24 object-cover rounded-lg bg-gray-100">
                                        <div class="flex flex-col gap-2">
                                            <button type="button" id="btn-carregar-foto" class="text-sm btn-secondary">Carregar do Dispositivo</button>
                                            <p class="text-xs text-secondary">Prefira imagens otimizadas (&lt;1MB).</p>
                                        </div>
                                    </div>
                                    <input type="file" id="input-foto" class="hidden" accept="image/*">
                                    <input type="hidden" id="foto-url">
                                </div>
                            </div>
                        </form>
                        <div class="bg-form-bg p-6 rounded-lg my-8">
                            <form id="form-receita" class="mb-6">
                                 <h3 class="text-xl font-semibold mb-3 text-blue-700">Adicionar Insumo</h3>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                    <div class="md:col-span-2"><label for="select-item" class="block text-sm font-medium text-secondary">Ingrediente ou Receita Base</label><select id="select-item" required class="mt-1 form-select"></select></div>
                                    <div><label for="quantidade-receita" class="block text-sm font-medium text-secondary">Qtd. Líquida</label><input type="number" step="0.001" id="quantidade-receita" placeholder="0.300" required class="mt-1 form-input"></div>
                                    <div><label for="fator-correcao-override" class="block text-sm font-medium text-secondary">Fator Correção</label><input type="number" step="0.001" id="fator-correcao-override" placeholder="Padrão" class="mt-1 form-input" disabled></div>
                                </div>
                                <button type="submit" class="w-full mt-4 btn-primary bg-amber-500 hover:bg-amber-600">Adicionar à Ficha</button>
                            </form>
                        </div>
                        <div class="overflow-x-auto mb-6">
                            <table class="min-w-full divide-y divide-border-color">
                                <thead class="table-header">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Item Insumo</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Unidade</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Qtd. Líquida</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">FC</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Qtd. Bruta</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Custo Unit.</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Custo Total</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-receita" class="divide-y divide-border-color"></tbody>
                            </table>
                        </div>
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-3">
                                 <label for="modo-preparo" class="block text-xl font-semibold text-blue-700">Modo de Preparo</label>
                                 <div class="flex items-center gap-2">
                                     <button type="button" id="btn-voice-to-text" class="p-2 rounded-full hover:bg-gray-200 transition-colors" title="Ditar modo de preparo">
                                        <svg class="w-6 h-6 text-secondary" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path></svg>
                                     </button>
                                     <button type="button" id="btn-assistente-receita" class="text-sm bg-gradient-to-r from-blue-500 to-teal-500 hover:from-blue-600 hover:to-teal-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                                        <span class="loader hidden"></span>
                                        <span>✨ Assistente</span>
                                    </button>
                                 </div>
                            </div>
                            <textarea id="modo-preparo" rows="6" class="w-full form-input" placeholder="Descreva os passos para preparar a receita..."></textarea>
                        </div>
                         <div class="mt-6 pt-6 border-t border-border-color space-y-6">
                            <div class="bg-form-bg p-4 rounded-lg text-right"><span class="text-xl font-semibold">Custo Total da Ficha:</span><span id="custo-total-receita" class="text-3xl font-bold ml-4 text-amber-600">R$ 0.00</span></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-purple-50 dark:bg-purple-900/20 p-6 rounded-lg flex flex-col justify-between border border-purple-200 dark:border-purple-800">
                                    <h4 class="font-semibold text-lg mb-3 text-purple-800 dark:text-purple-300">Salvar como Receita Base</h4>
                                    <p class="text-sm text-purple-600 dark:text-purple-400 mb-3">Salva a ficha para ser usada como insumo em outras receitas.</p>
                                    <button type="button" id="btn-salvar-receita" class="w-full mt-auto btn-primary bg-purple-600 hover:bg-purple-700">Salvar Receita Base</button>
                                </div>
                                <div class="bg-green-50 dark:bg-green-900/20 p-6 rounded-lg flex flex-col justify-between border border-green-200 dark:border-green-800">
                                    <h4 class="font-semibold text-lg mb-3 text-green-800 dark:text-green-300">Precificação e Prato Final</h4>
                                    <div class="grid grid-cols-2 gap-x-4 gap-y-2 mb-4">
                                        <div><label for="rendimento-receita-kg" class="block text-sm font-medium text-secondary">Rend. (kg)</label><input type="number" step="0.001" id="rendimento-receita-kg" placeholder="1.2" class="mt-1 form-input"></div>
                                        <div><label for="tamanho-porcao-g" class="block text-sm font-medium text-secondary">Porção (g)</label><input type="number" step="1" id="tamanho-porcao-g" placeholder="250" class="mt-1 form-input"></div>
                                        <div class="col-span-2 border-t border-border-color my-1"></div>
                                        <div class="text-sm text-secondary">Nº de Porções:</div><div id="numero-porcoes" class="text-sm font-semibold text-right">0</div>
                                        <div class="text-sm text-secondary">Custo por Kg:</div><div id="custo-por-kg" class="text-sm font-semibold text-right">R$ 0.00</div>
                                        <div class="text-sm text-secondary">Custo por Porção:</div><div id="custo-por-porcao" class="text-sm font-semibold text-right">R$ 0.00</div>
                                        <div class="text-sm text-secondary flex items-center">Markup:</div><input type="number" id="input-markup-prato" value="3" step="0.1" class="form-input text-right">
                                    </div>
                                    <div class="flex justify-between items-center pt-2 border-t border-green-300"><span class="font-semibold text-green-700">Preço de Venda Sugerido:</span><span id="preco-sugerido" class="text-2xl font-bold text-green-600">R$ 0.00</span></div>
                                    <button type="button" id="btn-salvar-prato" class="w-full mt-4 btn-primary bg-green-600 hover:bg-green-700">Salvar Prato Final</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- View de Consulta -->
                <div id="consultar-view" class="view">
                     <div class="card p-4 md:p-8">
                         <div class="flex justify-between items-center mb-6 border-b border-border-color pb-4">
                            <h3 class="text-2xl font-bold">Consultar Fichas Salvas</h3>
                            <button type="button" id="btn-importar-ficha" class="btn-secondary text-sm bg-purple-600 hover:bg-purple-700 text-white">✨ Importar Ficha Técnica com IA</button>
                        </div>
                        <div id="lista-fichas-salvas" class="space-y-3"></div>
                    </div>
                </div>

                <!-- View de Análise -->
                <div id="analise-view" class="view">
                     <div class="card p-4 md:p-8">
                         <div class="flex justify-between items-center mb-6 border-b border-border-color pb-4">
                            <h3 class="text-2xl font-bold">Análise Histórica de Custos</h3>
                         </div>
                         <div class="flex flex-col sm:flex-row gap-4 mb-4">
                            <input type="text" id="search-analise" class="flex-grow form-input" placeholder="Pesquisar por nome do prato...">
                            <select id="filter-analise" class="form-select">
                                <option value="todos">Todos os Tipos</option>
                                <option value="prato">Apenas Pratos</option>
                                <option value="base">Apenas Bases</option>
                            </select>
                         </div>
                         <div id="historico-custos-container" class="space-y-4"></div>
                     </div>
                </div>

                <!-- View de Margem -->
                <div id="margem-view" class="view">
                    <div class="card p-4 md:p-8">
                        <div class="flex justify-between items-center mb-6 border-b border-border-color pb-4">
                            <h3 class="text-2xl font-bold">Relatório de Margem</h3>
                        </div>
                        <div id="relatorio-margem-container" class="overflow-x-auto"></div>
                    </div>
                </div>

                <!-- View de Preços -->
                <div id="precos-view" class="view">
                     <div class="card p-4 md:p-8">
                        <div class="flex justify-between items-center mb-6 border-b border-border-color pb-4">
                            <h3 class="text-2xl font-bold">Lista de Preços de Venda</h3>
                        </div>
                        <div id="lista-precos-container" class="space-y-6"></div>
                        <button type="button" id="btn-salvar-lista-precos" class="w-full mt-6 btn-primary bg-green-600 hover:bg-green-700">Salvar Alterações nos Preços</button>
                    </div>
                </div>
                
                <!-- View de Vendas e CMV -->
                <div id="vendas-view" class="view">
                    <div class="card p-4 md:p-8">
                         <div class="flex justify-between items-center mb-6 border-b border-border-color pb-4">
                            <h3 class="text-2xl font-bold">Análise de Vendas e CMV</h3>
                        </div>
                        <div class="text-center mb-6">
                            <button id="btn-importar-vendas" class="btn-primary bg-red-600 hover:bg-red-700 py-3 px-6">Importar Relatório de Vendas (Simulação)</button>
                        </div>
                        <div id="relatorios-vendas-container" class="hidden space-y-8">
                            <div>
                                <h3 class="text-xl font-semibold mb-3 text-red-700">1. Desempenho e CMV por Prato</h3>
                                <div id="desempenho-cmv-container" class="overflow-x-auto"></div>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold mb-3 text-red-700">2. Engenharia de Cardápio</h3>
                                <div id="engenharia-cardapio-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                            </div>
                            <div>
                                <h3 class="text-xl font-semibold mb-3 text-red-700">3. Curva ABC de Lucro</h3>
                                <div id="curva-abc-container" class="space-y-4"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Edição de Ingrediente -->
    <div id="edit-ingredient-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center p-4">
        <div class="card p-6 w-full max-w-lg transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Editar Ingrediente</h3>
                <button id="btn-close-edit-modal" class="text-secondary hover:text-primary">&times;</button>
            </div>
            <form id="form-edit-ingrediente" class="space-y-4">
                <input type="hidden" id="edit-ingrediente-id">
                <div><label for="edit-nome-ingrediente" class="block text-sm font-medium text-secondary">Nome</label><input type="text" id="edit-nome-ingrediente" required class="mt-1 form-input"></div>
                <div><label for="edit-categoria-ingrediente" class="block text-sm font-medium text-secondary">Categoria</label><select id="edit-categoria-ingrediente" required class="mt-1 form-select"></select></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label for="edit-preco-compra" class="block text-sm font-medium text-secondary">Preço Compra (R$)</label><input type="number" step="0.01" id="edit-preco-compra" required class="mt-1 form-input"></div>
                    <div><label for="edit-unidade-compra-desc" class="block text-sm font-medium text-secondary">Embalagem</label><input type="text" id="edit-unidade-compra-desc" required class="mt-1 form-input"></div>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div><label for="edit-unidade-compra-qtd" class="block text-sm font-medium text-secondary">Volume</label><input type="number" step="0.001" id="edit-unidade-compra-qtd" required class="mt-1 form-input"></div>
                    <div><label for="edit-unidade-base" class="block text-sm font-medium text-secondary">Un. Base</label><input type="text" id="edit-unidade-base" required class="mt-1 form-input"></div>
                    <div><label for="edit-rendimento-ingrediente" class="block text-sm font-medium text-secondary">Rend. (%)</label><input type="number" step="1" id="edit-rendimento-ingrediente" required class="mt-1 form-input"></div>
                </div>
                <div class="flex gap-4 mt-6">
                     <button type="button" id="btn-delete-ingrediente" class="w-full btn-secondary bg-red-600 hover:bg-red-700 text-white">Excluir</button>
                     <button type="submit" class="w-full btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Importação de Ingredientes -->
    <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center p-4">
        <div class="card p-6 w-full max-w-4xl transform transition-all flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="text-2xl font-bold">Importar Ingredientes em Massa</h3>
                <button id="btn-close-modal" class="text-secondary hover:text-primary">&times;</button>
            </div>
            
            <div id="import-step-1" class="flex-shrink-0">
                <div class="text-sm bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-200 dark:border-blue-800 mb-4">
                    <p class="font-semibold">Passo 1: Cole os seus dados</p>
                    <p>Use <strong>1, 3 ou 5 colunas</strong>, separadas por tabulação (copiar do Excel/Sheets):</p>
                    <ul class="list-disc list-inside ml-4">
                        <li><code class="font-mono bg-gray-200 dark:bg-gray-700 px-1 rounded">Nome</code> (mínimo)</li>
                        <li><code class="font-mono bg-gray-200 dark:bg-gray-700 px-1 rounded">Nome; Unidade; Categoria</code> (básico)</li>
                        <li><code class="font-mono bg-gray-200 dark:bg-gray-700 px-1 rounded">Nome; Preço; Qtd Emb.; Unidade; Categoria</code> (completo)</li>
                    </ul>
                </div>
                <textarea id="import-textarea" rows="8" class="w-full form-input" placeholder="Cole os seus dados aqui..."></textarea>
            </div>

            <div id="import-step-2" class="hidden flex-grow overflow-y-auto mt-4">
                 <p class="font-semibold text-sm mb-2">Passo 2: Complete os dados e salve</p>
                 <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="table-header">
                            <tr>
                                <th class="px-2 py-2 text-left font-medium text-secondary">Nome</th>
                                <th class="px-2 py-2 text-left font-medium text-secondary w-28">Preço Compra</th>
                                <th class="px-2 py-2 text-left font-medium text-secondary w-28">Qtd. Embalagem</th>
                                <th class="px-2 py-2 text-left font-medium text-secondary">Unidade</th>
                                <th class="px-2 py-2 text-left font-medium text-secondary">Categoria</th>
                            </tr>
                        </thead>
                        <tbody id="import-edit-table-body">
                            <!-- Linhas de edição serão inseridas aqui -->
                        </tbody>
                    </table>
                 </div>
            </div>

            <div class="flex gap-4 mt-4 flex-shrink-0">
                <button id="btn-cancel-import" class="w-full btn-secondary">Cancelar</button>
                <button id="btn-load-for-edit" class="w-full btn-primary">
                    <span class="btn-text">Carregar para Edição</span>
                </button>
                <button id="btn-save-import" class="w-full btn-primary bg-green-600 hover:bg-green-700 hidden flex justify-center items-center">
                    <span class="btn-text">Salvar Importação</span>
                    <span class="loader hidden ml-2"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Importação de Ficha Técnica -->
    <div id="import-recipe-modal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center p-4">
        <div class="card p-6 w-full max-w-2xl transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Importador Inteligente de Ficha Técnica</h3>
                <button id="btn-close-recipe-modal" class="text-secondary hover:text-primary">&times;</button>
            </div>
            <div class="text-sm bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg border border-purple-200 dark:border-purple-800 mb-4">
                <p class="font-semibold">Instruções:</p>
                <p>Copie toda a sua ficha técnica da sua planilha (nome, lista de ingredientes, modo de preparo) e cole no campo abaixo. A IA irá ler, interpretar e preencher a ficha para si.</p>
            </div>
            <textarea id="import-recipe-textarea" rows="10" class="w-full form-input" placeholder="Cole a sua ficha técnica completa aqui..."></textarea>
            <div class="flex gap-4 mt-4">
                <button id="btn-cancel-recipe-import" class="w-full btn-secondary">Cancelar</button>
                <button id="btn-process-recipe-import" class="w-full btn-primary bg-purple-600 hover:bg-purple-700 flex justify-center items-center">
                    <span class="btn-text">✨ Analisar Ficha com IA</span>
                    <span class="loader hidden ml-2"></span>
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, onSnapshot, collection, query, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE SETUP ---
        let db, auth, restaurantId;

        // SUBSTITUA ISTO PELA CONFIGURAÇÃO DO SEU FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAxuTB2KsuxDi2ww8HEcqqi_tnzzPVR8Lw",
            authDomain: "cmv-ia.firebaseapp.com",
            projectId: "cmv-ia",
            storageBucket: "cmv-ia.firebasestorage.app",
            messagingSenderId: "587984899697",
            appId: "1:587984899697:web:d268195678b0e81cb515d0",
            measurementId: "G-V0R45F3XS5"
        };
        
        document.addEventListener('DOMContentLoaded', async () => {
            if (!firebaseConfig || !firebaseConfig.projectId || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
                document.body.innerHTML = `
                    <div class="w-full h-screen flex items-center justify-center p-8 bg-gray-100">
                        <div class="text-center bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                            <strong class="font-bold">Erro de Configuração!</strong>
                            <span class="block sm:inline">A configuração do Firebase não foi encontrada. Por favor, edite o ficheiro HTML e substitua o objeto 'firebaseConfig' pelas suas credenciais do Firebase.</span>
                        </div>
                    </div>
                `;
                return;
            }

            // --- BANCO DE DADOS E LÓGICA PRINCIPAL ---
            let ingredientes = [];
            let produtosVendaDireta = [];
            let receitasSalvas = [];
            let fichaAtual = { id: null, header: {}, componentes: [] };
            let historicoPrecos = [];
            let ingredientCategories = [];
            let dishCategories = [];
            let baseRecipeCategories = [];
            let directSaleCategories = [];
            
            // --- SELETORES DE ELEMENTOS ---
            const appContainer = document.getElementById('app-container');
            const authView = document.getElementById('auth-view');
            const sidebar = document.getElementById('sidebar');
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const views = document.querySelectorAll('.view');
            const navItems = document.querySelectorAll('[data-view]');
            const headerSubtitle = document.getElementById('header-subtitle');
            const themeToggle = document.getElementById('theme-toggle');
            const micToggle = document.getElementById('mic-toggle');
            const formIngrediente = document.getElementById('form-ingrediente');
            const listaIngredientesDiv = document.getElementById('lista-ingredientes');
            const formFichaHeader = document.getElementById('form-ficha-header');
            const formReceita = document.getElementById('form-receita');
            const selectItem = document.getElementById('select-item');
            const fatorCorrecaoOverrideInput = document.getElementById('fator-correcao-override');
            const tabelaReceitaBody = document.getElementById('tabela-receita');
            const custoTotalReceitaSpan = document.getElementById('custo-total-receita');
            const custoPorPorcaoSpan = document.getElementById('custo-por-porcao');
            const inputMarkupPrato = document.getElementById('input-markup-prato');
            const precoSugeridoSpan = document.getElementById('preco-sugerido');
            const btnSalvarReceita = document.getElementById('btn-salvar-receita');
            const btnSalvarPrato = document.getElementById('btn-salvar-prato');
            const btnNovaFicha = document.getElementById('btn-nova-ficha');
            const listaFichasSalvas = document.getElementById('lista-fichas-salvas');
            const btnImportarIngredientes = document.getElementById('btn-importar-ingredientes');
            const fotoPreview = document.getElementById('foto-preview');
            const fotoUrlInput = document.getElementById('foto-url');
            const btnCarregarFoto = document.getElementById('btn-carregar-foto');
            const btnGerarFotoIA = document.getElementById('btn-gerar-foto-ia');
            const btnAssistenteReceita = document.getElementById('btn-assistente-receita');
            const btnAbrirAtualizarPrecos = document.getElementById('btn-abrir-atualizar-precos');
            const painelAtualizarPrecos = document.getElementById('painel-atualizar-precos');
            const formAtualizarPrecos = document.getElementById('form-atualizar-precos');
            const btnSalvarNovosPrecos = document.getElementById('btn-salvar-novos-precos');
            const btnCancelarAtualizacao = document.getElementById('btn-cancelar-atualizacao');
            const historicoCustosContainer = document.getElementById('historico-custos-container');
            const rendimentoReceitaKgInput = document.getElementById('rendimento-receita-kg');
            const tamanhoPorcaoGInput = document.getElementById('tamanho-porcao-g');
            const numeroPorcoesSpan = document.getElementById('numero-porcoes');
            const custoPorKgSpan = document.getElementById('custo-por-kg');
            const modoPreparoTextarea = document.getElementById('modo-preparo');
            const btnVoiceToText = document.getElementById('btn-voice-to-text');
            const searchAnaliseInput = document.getElementById('search-analise');
            const filterAnaliseSelect = document.getElementById('filter-analise');
            const relatorioMargemContainer = document.getElementById('relatorio-margem-container');
            const listaPrecosContainer = document.getElementById('lista-precos-container');
            const btnSalvarListaPrecos = document.getElementById('btn-salvar-lista-precos');
            const btnImportarVendas = document.getElementById('btn-importar-vendas');
            const relatoriosVendasContainer = document.getElementById('relatorios-vendas-container');
            const desempenhoCmvContainer = document.getElementById('desempenho-cmv-container');
            const engenhariaCardapioContainer = document.getElementById('engenharia-cardapio-container');
            const curvaAbcContainer = document.getElementById('curva-abc-container');
            const formCatIngrediente = document.getElementById('form-cat-ingrediente');
            const formCatPrato = document.getElementById('form-cat-prato');
            const formCatBase = document.getElementById('form-cat-base');
            const formCatVenda = document.getElementById('form-cat-venda');
            const listaCatIngredientes = document.getElementById('lista-cat-ingredientes');
            const listaCatPratos = document.getElementById('lista-cat-pratos');
            const listaCatBases = document.getElementById('lista-cat-bases');
            const listaCatVenda = document.getElementById('lista-cat-venda');
            const categoriaIngredienteSelect = document.getElementById('categoria-ingrediente');
            const categoriaProdutoSelect = document.getElementById('categoria-produto');
            const searchIngredienteInput = document.getElementById('search-ingrediente');
            const filterIngredienteCategoriaSelect = document.getElementById('filter-ingrediente-categoria');
            const formProdutoVenda = document.getElementById('form-produto-venda');
            const listaProdutosVendaDiv = document.getElementById('lista-produtos-venda');
            const categoriaProdutoVendaSelect = document.getElementById('categoria-produto-venda');
            // Seletores do Modal de Importação de Ingredientes
            const importModal = document.getElementById('import-modal');
            const btnCloseModal = document.getElementById('btn-close-modal');
            const btnCancelImport = document.getElementById('btn-cancel-import');
            const importTextarea = document.getElementById('import-textarea');
            const btnLoadForEdit = document.getElementById('btn-load-for-edit');
            const btnSaveImport = document.getElementById('btn-save-import');
            const importStep1 = document.getElementById('import-step-1');
            const importStep2 = document.getElementById('import-step-2');
            const importEditTableBody = document.getElementById('import-edit-table-body');
            // Seletores do Modal de Importação de Ficha
            const btnImportarFicha = document.getElementById('btn-importar-ficha');
            const importRecipeModal = document.getElementById('import-recipe-modal');
            const btnCloseRecipeModal = document.getElementById('btn-close-recipe-modal');
            const btnCancelRecipeImport = document.getElementById('btn-cancel-recipe-import');
            const importRecipeTextarea = document.getElementById('import-recipe-textarea');
            const btnProcessRecipeImport = document.getElementById('btn-process-recipe-import');
            // Novos seletores para edição de ingredientes
            const editIngredientModal = document.getElementById('edit-ingredient-modal');
            const btnCloseEditModal = document.getElementById('btn-close-edit-modal');
            const formEditIngrediente = document.getElementById('form-edit-ingrediente');
            const btnDeleteIngrediente = document.getElementById('btn-delete-ingrediente');
            // Novo seletor para upload de foto
            const inputFileFoto = document.getElementById('input-foto');


            // --- FUNÇÕES DE SETUP DO FIREBASE (MOVENDO PARA DENTRO DO DOMCONTENTLOADED) ---
            function getCollectionPath(collectionName) {
                if (!restaurantId) return null;
                return `/restaurants/${restaurantId}/${collectionName}`;
            }

            async function saveCategories() {
                const path = getCollectionPath('categories');
                if (!path) return;
                const categoriesData = {
                    ingredientCategories,
                    dishCategories,
                    baseRecipeCategories,
                    directSaleCategories
                };
                await setDoc(doc(db, path, 'main'), categoriesData);
            }

            function setupRealtimeListeners() {
                if (!restaurantId) return;

                // Listener para Categorias
                onSnapshot(doc(db, getCollectionPath('categories'), 'main'), (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        ingredientCategories = data.ingredientCategories || [];
                        dishCategories = data.dishCategories || [];
                        baseRecipeCategories = data.baseRecipeCategories || [];
                        directSaleCategories = data.directSaleCategories || [];
                    }
                    renderAllCategoryLists();
                });

                // Listener para Ingredientes
                onSnapshot(query(collection(db, getCollectionPath('ingredients'))), (snapshot) => {
                    ingredientes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderizarIngredientes(searchIngredienteInput.value, filterIngredienteCategoriaSelect.value);
                });

                // Listener para Produtos de Venda Direta
                onSnapshot(query(collection(db, getCollectionPath('direct_sale_products'))), (snapshot) => {
                    produtosVendaDireta = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderizarProdutosVendaDireta();
                });

                // Listener para Receitas/Fichas
                onSnapshot(query(collection(db, getCollectionPath('recipes'))), (snapshot) => {
                    receitasSalvas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const activeViewEl = document.querySelector('.view.active');
                    if (activeViewEl) {
                        const activeView = activeViewEl.id.replace('-view', '');
                        if (['consultar', 'precos', 'margem', 'analise'].includes(activeView)) {
                            showView(activeView);
                        }
                    }
                });
                
                // Listener para Histórico de Preços
                onSnapshot(query(collection(db, getCollectionPath('price_history'))), (snapshot) => {
                    historicoPrecos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const activeViewEl = document.querySelector('.view.active');
                    if (activeViewEl && activeViewEl.id === 'analise-view') {
                        renderizarAnaliseDeCustos(searchAnaliseInput.value, filterAnaliseSelect.value);
                    }
                });
            }
            
            // --- LÓGICA DE NAVEGAÇÃO E TEMA ---
            const subtitleMap = {
                dashboard: 'Dashboard',
                settings: 'Configurações',
                ingredientes: 'Banco de Ingredientes',
                'venda-direta': 'Produtos de Venda Direta',
                fichas: 'Ficha Técnica Gerencial',
                consultar: 'Consultar Fichas Salvas',
                analise: 'Análise de Custos',
                margem: 'Relatório de Margens',
                precos: 'Lista de Preços de Venda',
                vendas: 'Análise de Vendas e CMV'
            };
            
            function toggleSidebar() {
                sidebar.classList.toggle('-translate-x-full');
                sidebarOverlay.classList.toggle('hidden');
            }

            hamburgerBtn.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);
            
            function showView(viewId) {
                views.forEach(view => view.classList.remove('active'));
                const activeView = document.getElementById(viewId + '-view');
                if (activeView) {
                    activeView.classList.add('active');
                    headerSubtitle.textContent = subtitleMap[viewId] || 'Dashboard';
                    
                    navItems.forEach(nav => {
                        if (nav.dataset.view === viewId) {
                            nav.classList.add('bg-blue-50', 'text-blue-600', 'font-semibold');
                        } else {
                            nav.classList.remove('bg-blue-50', 'text-blue-600', 'font-semibold');
                        }
                    });

                    if (window.innerWidth < 768) { // md breakpoint
                        if(!sidebar.classList.contains('-translate-x-full')) {
                        toggleSidebar();
                        }
                    }

                    // Refresh data on view change
                    if (viewId === 'consultar') renderizarFichasParaConsulta();
                    if (viewId === 'analise') renderizarAnaliseDeCustos();
                    if (viewId === 'margem') renderizarRelatorioMargem();
                    if (viewId === 'precos') renderizarListaDePrecos();
                    if (viewId === 'ingredientes') populateIngredientCategoryDropdowns();
                    if (viewId === 'venda-direta') populateDirectSaleCategoryDropdown();
                    if (viewId === 'fichas') {
                        populateDishCategoryDropdown();
                        popularDropdownItens();
                    }
                }
            }
            
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewName = item.dataset.view;
                    if(viewName === 'fichas') limparFicha();
                    showView(viewName);
                });
            });
            document.querySelector('button[data-view="settings"]').addEventListener('click', () => showView('settings'));

            // --- FUNÇÕES DE CATEGORIA ---
            function renderCategoryList(list, container, colorClass, type) {
                container.innerHTML = '';
                if (list.length === 0) {
                    container.innerHTML = '<li class="text-secondary">Nenhuma categoria.</li>';
                    return;
                }
                list.forEach(cat => {
                    const li = document.createElement('li');
                    li.className = `flex justify-between items-center bg-${colorClass}-100 text-${colorClass}-800 dark:bg-opacity-20 dark:text-${colorClass}-300 p-2 rounded-md`;
                    li.innerHTML = `
                        <span>${cat}</span>
                        <div class="flex gap-2">
                            <button class="btn-edit-cat" data-name="${cat}" data-type="${type}" title="Editar">
                                <svg class="w-4 h-4 hover:text-blue-500 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                            </button>
                            <button class="btn-delete-cat" data-name="${cat}" data-type="${type}" title="Excluir">
                                <svg class="w-4 h-4 hover:text-red-500 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                    container.appendChild(li);
                });
            }
            
            function renderAllCategoryLists() {
                renderCategoryList(ingredientCategories, listaCatIngredientes, 'blue', 'ingredient');
                renderCategoryList(directSaleCategories, listaCatVenda, 'orange', 'directSale');
                renderCategoryList(dishCategories, listaCatPratos, 'green', 'dish');
                renderCategoryList(baseRecipeCategories, listaCatBases, 'purple', 'base');
                populateIngredientCategoryDropdowns();
                populateDirectSaleCategoryDropdown();
                populateDishCategoryDropdown();
            }

            async function addCategory(event, categoryArray, inputId) {
                event.preventDefault();
                const form = event.target;
                const button = form.querySelector('button[type="submit"]');
                const originalText = button.textContent;
                button.textContent = '...';
                button.disabled = true;

                const input = document.getElementById(inputId);
                const categoryName = input.value.trim().toUpperCase();
                if (categoryName && !categoryArray.includes(categoryName)) {
                    categoryArray.push(categoryName);
                    categoryArray.sort();
                    await saveCategories();
                }
                input.value = '';
                button.textContent = 'OK!';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                }, 1000);
            }

            async function deleteCategory(name, type) {
                let categoryArray;
                if (type === 'ingredient') categoryArray = ingredientCategories;
                else if (type === 'dish') categoryArray = dishCategories;
                else if (type === 'base') categoryArray = baseRecipeCategories;
                else if (type === 'directSale') categoryArray = directSaleCategories;

                const index = categoryArray.indexOf(name);
                if (index > -1) {
                    categoryArray.splice(index, 1);
                    await saveCategories();
                }
            }

            async function editCategory(oldName, type) {
                let categoryArray;
                let itemsToUpdate = [];
                let collectionName;
                
                if (type === 'ingredient') {
                    categoryArray = ingredientCategories;
                    itemsToUpdate = ingredientes.filter(i => i.category === oldName);
                    collectionName = 'ingredients';
                } else if (type === 'dish') {
                    categoryArray = dishCategories;
                    itemsToUpdate = receitasSalvas.filter(r => r.type === 'prato' && r.header.categoria === oldName);
                    collectionName = 'recipes';
                } else if (type === 'base') {
                    categoryArray = baseRecipeCategories;
                    itemsToUpdate = receitasSalvas.filter(r => r.type === 'base' && r.header.categoria === oldName);
                    collectionName = 'recipes';
                } else if (type === 'directSale') {
                    categoryArray = directSaleCategories;
                    itemsToUpdate = produtosVendaDireta.filter(p => p.category === oldName);
                    collectionName = 'direct_sale_products';
                }

                const newName = prompt(`Editar categoria "${oldName}":`, oldName)?.trim().toUpperCase();

                if (newName && newName !== oldName && !categoryArray.includes(newName)) {
                    const index = categoryArray.indexOf(oldName);
                    if (index > -1) {
                        categoryArray[index] = newName;
                        categoryArray.sort();

                        const updatePromises = itemsToUpdate.map(item => {
                            const itemRef = doc(db, getCollectionPath(collectionName), item.id);
                            const fieldToUpdate = (type === 'dish' || type === 'base') ? 'header.categoria' : 'category';
                            return updateDoc(itemRef, { [fieldToUpdate]: newName });
                        });
                        
                        await Promise.all(updatePromises);
                        await saveCategories();
                    }
                } else if (newName && categoryArray.includes(newName)) {
                    alert("Essa categoria já existe.");
                }
            }

            function populateIngredientCategoryDropdowns() {
                const selects = [categoriaIngredienteSelect, filterIngredienteCategoriaSelect];
                selects.forEach(select => {
                    const currentValue = select.value;
                    select.innerHTML = ''; // Limpa
                    if(select.id === 'filter-ingrediente-categoria') {
                        select.innerHTML += '<option value="all">TODAS AS CATEGORIAS</option>';
                    } else {
                        select.innerHTML += '<option value="">SELECIONE...</option>';
                    }
                    ingredientCategories.forEach(cat => {
                        select.innerHTML += `<option value="${cat}">${cat}</option>`;
                    });
                    if (ingredientCategories.includes(currentValue)) {
                        select.value = currentValue;
                    }
                });
            }

            function populateDirectSaleCategoryDropdown() {
                const currentValue = categoriaProdutoVendaSelect.value;
                categoriaProdutoVendaSelect.innerHTML = '<option value="">SELECIONE...</option>';
                directSaleCategories.forEach(cat => {
                    categoriaProdutoVendaSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
                });
                if (directSaleCategories.includes(currentValue)) {
                    categoriaProdutoVendaSelect.value = currentValue;
                }
            }

            function populateDishCategoryDropdown() {
                const currentValue = categoriaProdutoSelect.value;
                categoriaProdutoSelect.innerHTML = '<option value="">SELECIONE...</option>';
                let valueExists = false;

                const pratosOptgroup = document.createElement('optgroup');
                pratosOptgroup.label = '--- PRATOS FINAIS ---';
                dishCategories.forEach(cat => {
                    pratosOptgroup.innerHTML += `<option value="${cat}">${cat}</option>`;
                    if (cat === currentValue) valueExists = true;
                });
                categoriaProdutoSelect.appendChild(pratosOptgroup);

                const basesOptgroup = document.createElement('optgroup');
                basesOptgroup.label = '--- RECEITAS BASE ---';
                baseRecipeCategories.forEach(cat => {
                    basesOptgroup.innerHTML += `<option value="${cat}">${cat}</option>`;
                     if (cat === currentValue) valueExists = true;
                });
                categoriaProdutoSelect.appendChild(basesOptgroup);

                if (valueExists) {
                    categoriaProdutoSelect.value = currentValue;
                }
            }

            // --- FUNÇÕES DE RENDERIZAÇÃO ---
            function renderizarIngredientes(searchTerm = '', filterCategory = 'all') {
                listaIngredientesDiv.innerHTML = '';
                
                const filtered = ingredientes.filter(ing => {
                    const nameMatch = ing.nome.toLowerCase().includes(searchTerm.toLowerCase());
                    const categoryMatch = filterCategory === 'all' || ing.category === filterCategory;
                    return nameMatch && categoryMatch;
                });

                if (filtered.length === 0) {
                    listaIngredientesDiv.innerHTML = '<p class="text-secondary text-center py-4">Nenhum ingrediente encontrado.</p>';
                    return;
                }
                
                const grouped = filtered.reduce((acc, ing) => {
                    const cat = ing.category || 'SEM CATEGORIA';
                    if (!acc[cat]) acc[cat] = [];
                    acc[cat].push(ing);
                    return acc;
                }, {});

                Object.keys(grouped).sort().forEach(category => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.innerHTML = `<h4 class="text-md font-semibold text-blue-700 dark:text-blue-400 mb-2 pb-1 border-b border-border-color">${category}</h4>`;
                    const ul = document.createElement('ul');
                    ul.className = 'space-y-2';
                    
                    grouped[category].sort((a, b) => a.nome.localeCompare(b.nome)).forEach(ing => {
                        const li = document.createElement('li');
                        li.className = 'bg-form-bg p-3 rounded-lg flex justify-between items-center border border-border-color cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors';
                        li.dataset.id = ing.id;
                        li.innerHTML = `
                            <div>
                                <span class="font-semibold">${ing.nome}</span>
                                <div class="text-xs text-secondary">Compra: ${ing.unidadeCompraQtd} ${ing.unidadeBase} por R$ ${ing.precoCompra.toFixed(2)}</div>
                            </div>
                            <div class="text-right">
                                <span class="font-bold text-blue-600">R$ ${ing.custoBase.toFixed(2)} / ${ing.unidadeBase}</span>
                                <div class="text-xs text-secondary">Rend: ${ing.rendimento}%</div>
                            </div>`;
                        ul.appendChild(li);
                    });
                    categoryDiv.appendChild(ul);
                    listaIngredientesDiv.appendChild(categoryDiv);
                });

                popularDropdownItens();
            }

            function renderizarProdutosVendaDireta() {
                listaProdutosVendaDiv.innerHTML = '';
                
                if (produtosVendaDireta.length === 0) {
                    listaProdutosVendaDiv.innerHTML = '<p class="text-secondary text-center py-4">Nenhum produto de venda direta cadastrado.</p>';
                    return;
                }

                const grouped = produtosVendaDireta.reduce((acc, prod) => {
                    const cat = prod.category || 'SEM CATEGORIA';
                    if (!acc[cat]) acc[cat] = [];
                    acc[cat].push(prod);
                    return acc;
                }, {});

                Object.keys(grouped).sort().forEach(category => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.innerHTML = `<h4 class="text-md font-semibold text-orange-700 dark:text-orange-400 mb-2 pb-1 border-b border-border-color">${category}</h4>`;
                    const ul = document.createElement('ul');
                    ul.className = 'space-y-2';
                    
                    grouped[category].sort((a, b) => a.nome.localeCompare(b.nome)).forEach(prod => {
                        const li = document.createElement('li');
                        li.className = 'bg-form-bg p-3 rounded-lg flex justify-between items-center border border-border-color';
                        li.innerHTML = `
                            <div>
                                <span class="font-semibold">${prod.nome}</span>
                                <div class="text-xs text-secondary">Compra: R$ ${prod.precoCompra.toFixed(2)} | Venda: R$ ${prod.precoVenda.toFixed(2)}</div>
                            </div>
                            <div class="text-right">
                                <span class="font-bold text-green-600">Margem: R$ ${(prod.precoVenda - prod.precoCompra).toFixed(2)}</span>
                                <div class="text-xs text-secondary">Perda: ${prod.taxaPerda}%</div>
                            </div>`;
                        ul.appendChild(li);
                    });
                    categoryDiv.appendChild(ul);
                    listaProdutosVendaDiv.appendChild(categoryDiv);
                });
            }

            function renderizarFichasParaConsulta() {
                listaFichasSalvas.innerHTML = '';
                const sortedFichas = [...receitasSalvas].sort((a, b) => a.header.descricaoProduto.localeCompare(b.header.descricaoProduto));
                if (sortedFichas.length === 0) {
                    listaFichasSalvas.innerHTML = '<p class="text-secondary text-center">Nenhuma ficha salva.</p>';
                    return;
                }
                sortedFichas.forEach(ficha => {
                    const custoPorPorcao = (ficha.custoTotal / ficha.header.rendimentoReceitaKg) * (ficha.header.tamanhoPorcaoG / 1000) || 0;
                    const tipoFicha = ficha.type === 'base' 
                        ? '<span class="text-xs font-semibold bg-purple-600 text-white px-2 py-1 rounded-full">BASE</span>' 
                        : '<span class="text-xs font-semibold bg-green-600 text-white px-2 py-1 rounded-full">PRATO</span>';

                    const div = document.createElement('div');
                    div.className = 'bg-form-bg p-3 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center border border-border-color gap-3';
                    div.innerHTML = `
                        <div class="flex items-center gap-4">
                            ${tipoFicha}
                            <div>
                                <span class="font-semibold">${ficha.header.descricaoProduto}</span>
                                <div class="text-xs text-secondary">Categoria: ${ficha.header.categoria} | Custo/Porção: R$ ${custoPorPorcao.toFixed(2)}</div>
                            </div>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            <button type="button" data-id="${ficha.id}" data-custo="true" class="btn-exportar-pdf bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg text-sm">PDF (Custo)</button>
                            <button type="button" data-id="${ficha.id}" data-custo="false" class="btn-exportar-pdf btn-secondary text-sm py-1 px-3">PDF (Op.)</button>
                            <button type="button" data-id="${ficha.id}" class="btn-carregar-ficha btn-primary text-sm py-1 px-3">Carregar</button>
                        </div>
                    `;
                    listaFichasSalvas.appendChild(div);
                });
                document.querySelectorAll('.btn-carregar-ficha').forEach(btn => btn.addEventListener('click', (e) => carregarFicha(e.currentTarget.dataset.id)));
                document.querySelectorAll('.btn-exportar-pdf').forEach(btn => btn.addEventListener('click', (e) => {
                    const fichaId = e.currentTarget.dataset.id;
                    const incluirCustos = e.currentTarget.dataset.custo === 'true';
                    gerarPDF(fichaId, incluirCustos);
                }));
            }

            function popularDropdownItens() {
                selectItem.innerHTML = '<option value="">SELECIONE...</option>';
                if (ingredientes.length > 0) {
                    const groupIng = document.createElement('optgroup');
                    groupIng.label = '--- INGREDIENTES ---';
                    [...ingredientes].sort((a,b) => a.nome.localeCompare(b.nome)).forEach(ing => {
                        const option = document.createElement('option');
                        option.value = `ing_${ing.id}`;
                        option.textContent = `${ing.nome} (${ing.unidadeBase})`;
                        groupIng.appendChild(option);
                    });
                    selectItem.appendChild(groupIng);
                }
                if (receitasSalvas.length > 0) {
                    const groupRec = document.createElement('optgroup');
                    groupRec.label = '--- RECEITAS BASE ---';
                    receitasSalvas.filter(r => r.type === 'base').sort((a,b) => a.header.descricaoProduto.localeCompare(b.header.descricaoProduto)).forEach(rec => {
                        const option = document.createElement('option');
                        option.value = `rec_${rec.id}`;
                        option.textContent = rec.header.descricaoProduto;
                        groupRec.appendChild(option);
                    });
                    selectItem.appendChild(groupRec);
                }
            }

            function renderizarFichaAtual() {
                tabelaReceitaBody.innerHTML = '';
                fichaAtual.componentes.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.className = `table-row hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors ${item.type === 'rec' ? 'text-purple-600 dark:text-purple-400' : ''}`;
                    tr.innerHTML = `
                        <td class="px-4 py-2 whitespace-nowrap font-medium">${item.nome} ${item.type === 'rec' ? '(R)' : ''}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-secondary">${item.unidade}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-secondary">${item.qtdeLiquida.toFixed(3)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-secondary">${item.fatorCorrecao.toFixed(3)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-secondary">${item.qtdeBruta.toFixed(3)}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-secondary">R$ ${item.custoUnitario.toFixed(2)}</td>
                        <td class="px-4 py-2 whitespace-nowrap font-semibold text-amber-600">R$ ${item.custoTotal.toFixed(2)}</td>`;
                    tabelaReceitaBody.appendChild(tr);
                });
                calcularCustosFinais();
            }

            function renderizarAnaliseDeCustos(searchTerm = '', filterType = 'todos') {
                historicoCustosContainer.innerHTML = '';
                if (historicoPrecos.length === 0) {
                    historicoCustosContainer.innerHTML = '<p class="text-secondary text-center">Nenhum histórico de preços foi salvo ainda. Atualize os preços dos ingredientes para começar.</p>';
                    return;
                }

                [...historicoPrecos].reverse().forEach(historico => {
                    const dataFormatada = new Date(historico.date).toLocaleString('pt-BR');
                    let htmlInterno = '';
                    
                    const filteredRecipes = historico.recipeCosts.filter(rec => {
                        const searchTermMatch = rec.header.descricaoProduto.toLowerCase().includes(searchTerm.toLowerCase());
                        const typeMatch = filterType === 'todos' || rec.type === filterType;
                        return searchTermMatch && typeMatch;
                    });

                    if (filteredRecipes.length > 0) {
                        htmlInterno += '<div class="space-y-2">';
                        filteredRecipes.sort((a,b) => a.header.descricaoProduto.localeCompare(b.header.descricaoProduto)).forEach(recHist => {
                            const recAtual = receitasSalvas.find(r => r.id === recHist.id);
                            if(recAtual) {
                                const custoAntigo = recHist.custoTotal;
                                const custoAtual = recalcularCustoFicha(recAtual, ingredientes);
                                const variacao = custoAntigo > 0 ? ((custoAtual - custoAntigo) / custoAntigo) * 100 : 0;
                                const corVariacao = variacao > 0 ? 'text-red-600' : 'text-green-600';
                                const sinalVariacao = variacao > 0 ? '+' : '';

                                htmlInterno += `
                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 items-center text-sm p-2 bg-bg-secondary rounded-md">
                                        <span class="font-semibold">${recHist.header.descricaoProduto}</span>
                                        <span>Custo Antigo: <span class="font-medium">R$ ${custoAntigo.toFixed(2)}</span></span>
                                        <span>Custo Atual: <span class="font-medium">R$ ${custoAtual.toFixed(2)}</span> <span class="${corVariacao}">(${sinalVariacao}${variacao.toFixed(2)}%)</span></span>
                                    </div>
                                `;
                            }
                        });
                        htmlInterno += '</div>';
                    } else {
                        htmlInterno += '<p class="text-secondary text-sm">Nenhum prato encontrado para esta data com os filtros aplicados.</p>';
                    }

                    const details = document.createElement('details');
                    details.className = 'bg-form-bg rounded-lg border border-border-color';
                    details.innerHTML = `
                        <summary class="p-4 cursor-pointer text-lg font-semibold text-yellow-800 dark:text-yellow-400">Atualização de ${dataFormatada}</summary>
                        <div class="p-4 border-t border-border-color">${htmlInterno}</div>
                    `;
                    historicoCustosContainer.appendChild(details);
                });
            }

            function renderizarRelatorioMargem() {
                relatorioMargemContainer.innerHTML = '';
                
                const pratos = receitasSalvas.filter(r => r.type === 'prato').map(p => ({
                    nome: p.header.descricaoProduto,
                    custo: (p.custoTotal / p.header.rendimentoReceitaKg) * (p.header.tamanhoPorcaoG / 1000) || 0,
                    precoVenda: p.header.precoVenda || 0
                }));

                const produtosVenda = produtosVendaDireta.map(p => ({
                    nome: p.nome,
                    custo: p.precoCompra,
                    precoVenda: p.precoVenda
                }));

                const todosItens = [...pratos, ...produtosVenda].sort((a,b) => a.nome.localeCompare(b.nome));

                if (todosItens.length === 0) {
                    relatorioMargemContainer.innerHTML = '<p class="text-secondary text-center">Nenhum item de venda para gerar relatório.</p>';
                    return;
                }

                let tableHTML = `
                    <table class="min-w-full divide-y divide-border-color">
                        <thead class="table-header">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Item</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Custo Unitário</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Preço Venda</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Margem (R$)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Margem (%)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-border-color">
                `;

                todosItens.forEach(item => {
                    const margemReais = item.precoVenda - item.custo;
                    const margemPercent = item.precoVenda > 0 ? (margemReais / item.precoVenda) * 100 : 0;
                    const corMargem = margemReais > 0 ? 'text-green-600' : 'text-red-600';

                    tableHTML += `
                        <tr class="table-row">
                            <td class="px-4 py-2 whitespace-nowrap font-medium">${item.nome}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-secondary">R$ ${item.custo.toFixed(2)}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-secondary">R$ ${item.precoVenda.toFixed(2)}</td>
                            <td class="px-4 py-2 whitespace-nowrap font-semibold ${corMargem}">R$ ${margemReais.toFixed(2)}</td>
                            <td class="px-4 py-2 whitespace-nowrap font-semibold ${corMargem}">${margemPercent.toFixed(2)}%</td>
                        </tr>
                    `;
                });

                tableHTML += '</tbody></table>';
                relatorioMargemContainer.innerHTML = tableHTML;
            }

            function renderizarListaDePrecos() {
                listaPrecosContainer.innerHTML = '';
                const pratos = receitasSalvas.filter(r => r.type === 'prato');
                
                if (pratos.length === 0 && produtosVendaDireta.length === 0) {
                    listaPrecosContainer.innerHTML = '<p class="text-secondary text-center">Nenhum item de venda para editar preços.</p>';
                    return;
                }

                const groupedPratos = pratos.reduce((acc, prato) => {
                    const category = prato.header.categoria || 'SEM CATEGORIA';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(prato);
                    return acc;
                }, {});

                const groupedProdutos = produtosVendaDireta.reduce((acc, prod) => {
                    const category = prod.category || 'SEM CATEGORIA';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(prod);
                    return acc;
                }, {});

                const allCategories = [...new Set([...Object.keys(groupedPratos), ...Object.keys(groupedProdutos)])].sort();

                let html = '';
                allCategories.forEach(category => {
                    const pratosDaCategoria = (groupedPratos[category] || []).sort((a,b) => a.header.descricaoProduto.localeCompare(b.header.descricaoProduto));
                    const produtosDaCategoria = (groupedProdutos[category] || []).sort((a,b) => a.nome.localeCompare(b.nome));
                    
                    html += `
                        <div class="bg-form-bg p-4 rounded-lg border border-border-color" data-category="${category}">
                            <div class="flex flex-col sm:flex-row justify-between items-center mb-3 border-b border-border-color pb-2">
                                <h3 class="text-xl font-semibold text-blue-800 dark:text-blue-400">${category}</h3>
                            </div>
                            <div class="space-y-2 mt-2">
                    `;

                    pratosDaCategoria.forEach(prato => {
                        const custoPorPorcao = (prato.custoTotal / prato.header.rendimentoReceitaKg) * (prato.header.tamanhoPorcaoG / 1000) || 0;
                        const precoVenda = prato.header.precoVenda || 0;
                        const margemAtual = precoVenda > 0 ? ((precoVenda - custoPorcao) / precoVenda) * 100 : 0;

                        html += `
                            <div class="grid grid-cols-1 sm:grid-cols-5 gap-4 items-center text-sm prato-item" data-id="${prato.id}" data-type="prato" data-custo="${custoPorPorcao}">
                                <span class="sm:col-span-2">${prato.header.descricaoProduto} <span class="text-xs text-green-500">(PRATO)</span></span>
                                <span class="text-secondary">R$ ${precoVenda.toFixed(2)} (${margemAtual.toFixed(2)}%)</span>
                                <input type="number" step="0.01" value="${precoVenda.toFixed(2)}" class="novo-preco-input form-input text-right">
                                <span class="nova-margem-span text-right font-semibold">${margemAtual.toFixed(2)}%</span>
                            </div>
                        `;
                    });
                    
                    produtosDaCategoria.forEach(prod => {
                        const precoVenda = prod.precoVenda || 0;
                        const margemAtual = precoVenda > 0 ? ((precoVenda - prod.precoCompra) / precoVenda) * 100 : 0;

                        html += `
                            <div class="grid grid-cols-1 sm:grid-cols-5 gap-4 items-center text-sm prato-item" data-id="${prod.id}" data-type="produto" data-custo="${prod.precoCompra}">
                                <span class="sm:col-span-2">${prod.nome} <span class="text-xs text-orange-500">(PRODUTO)</span></span>
                                <span class="text-secondary">R$ ${precoVenda.toFixed(2)} (${margemAtual.toFixed(2)}%)</span>
                                <input type="number" step="0.01" value="${precoVenda.toFixed(2)}" class="novo-preco-input form-input text-right">
                                <span class="nova-margem-span text-right font-semibold">${margemAtual.toFixed(2)}%</span>
                            </div>
                        `;
                    });

                    html += '</div></div>';
                });
                listaPrecosContainer.innerHTML = html;
                
                document.querySelectorAll('.novo-preco-input').forEach(input => input.addEventListener('input', atualizarNovaMargem));
            }

            // --- FUNÇÕES DE CÁLCULO ---
            function calcularCustosFinais() {
                const custoTotal = fichaAtual.componentes.reduce((acc, item) => acc + item.custoTotal, 0);
                custoTotalReceitaSpan.textContent = `R$ ${custoTotal.toFixed(2)}`;
                
                const rendimentoReceitaKg = parseFloat(rendimentoReceitaKgInput.value) || 0;
                const tamanhoPorcaoG = parseFloat(tamanhoPorcaoGInput.value) || 0;

                let custoPorKg = 0;
                if (rendimentoReceitaKg > 0) custoPorKg = custoTotal / rendimentoReceitaKg;
                custoPorKgSpan.textContent = `R$ ${custoPorKg.toFixed(2)}`;

                let numeroPorcoes = 0;
                if (tamanhoPorcaoG > 0 && rendimentoReceitaKg > 0) numeroPorcoes = (rendimentoReceitaKg * 1000) / tamanhoPorcaoG;
                numeroPorcoesSpan.textContent = numeroPorcoes.toFixed(1);

                let custoPorPorcao = 0;
                if (custoPorKg > 0 && tamanhoPorcaoG > 0) custoPorPorcao = custoPorKg * (tamanhoPorcaoG / 1000);
                custoPorPorcaoSpan.textContent = `R$ ${custoPorPorcao.toFixed(2)}`;
                
                const markup = parseFloat(inputMarkupPrato.value) || 0;
                const precoSugerido = custoPorPorcao * markup;
                precoSugeridoSpan.textContent = `R$ ${precoSugerido.toFixed(2)}`;
            }
            
            function recalcularCustoFicha(ficha, listaIngredientes) {
                return ficha.componentes.reduce((total, item) => {
                    if (item.type === 'ing') {
                        const ingAtual = listaIngredientes.find(i => i.nome === item.nome);
                        if (ingAtual) return total + (item.qtdeBruta * ingAtual.custoBase);
                    } else if (item.type === 'rec') {
                        const recBase = receitasSalvas.find(r => r.header.descricaoProduto === item.nome);
                        if(recBase) {
                            const custoRecBaseAtual = recalcularCustoFicha(recBase, listaIngredientes);
                            const custoPorUnidadeBase = custoRecBaseAtual / (recBase.header.rendimentoReceitaKg || 1);
                            return total + (item.qtdeLiquida * custoPorUnidadeBase);
                        }
                    }
                    return total;
                }, 0);
            }

            function limparFicha() {
                fichaAtual = { id: null, header: {}, componentes: [] };
                formFichaHeader.reset();
                rendimentoReceitaKgInput.value = '';
                tamanhoPorcaoGInput.value = '';
                document.getElementById('modo-preparo').value = '';
                fotoPreview.src = 'https://placehold.co/100x100/e0e7ff/4338ca?text=Foto';
                fotoUrlInput.value = '';
                renderizarFichaAtual();
            }
            
            function carregarFicha(id) {
                const fichaParaCarregar = receitasSalvas.find(f => f.id == id);
                if(fichaParaCarregar) {
                    document.getElementById('descricao-produto').value = fichaParaCarregar.header.descricaoProduto;
                    categoriaProdutoSelect.value = fichaParaCarregar.header.categoria;
                    rendimentoReceitaKgInput.value = fichaParaCarregar.header.rendimentoReceitaKg || '';
                    tamanhoPorcaoGInput.value = fichaParaCarregar.header.tamanhoPorcaoG || '';
                    fotoUrlInput.value = fichaParaCarregar.header.fotoUrl || '';
                    fotoPreview.src = fichaParaCarregar.header.fotoUrl || 'https://placehold.co/100x100/e0e7ff/4338ca?text=Foto';
                    document.getElementById('modo-preparo').value = fichaParaCarregar.header.modoPreparo || '';
                    fichaAtual = JSON.parse(JSON.stringify(fichaParaCarregar));
                    renderizarFichaAtual();
                    showView('fichas');
                }
            }

            async function salvarFicha(tipo) {
                const custoPorPorcao = parseFloat(custoPorPorcaoSpan.textContent.replace('R$ ', '')) || 0;
                const markup = parseFloat(inputMarkupPrato.value) || 3;
                const precoSugerido = custoPorPorcao * markup;

                const header = {
                    descricaoProduto: document.getElementById('descricao-produto').value.toUpperCase(),
                    categoria: document.getElementById('categoria-produto').value,
                    rendimentoReceitaKg: parseFloat(rendimentoReceitaKgInput.value),
                    tamanhoPorcaoG: parseFloat(tamanhoPorcaoGInput.value),
                    fotoUrl: fotoUrlInput.value,
                    modoPreparo: document.getElementById('modo-preparo').value.toUpperCase(),
                    precoVenda: precoSugerido
                };
                if (!header.descricaoProduto || fichaAtual.componentes.length === 0) { alert("Preencha a descrição e adicione insumos antes de salvar."); return; }
                
                const custoTotal = fichaAtual.componentes.reduce((acc, item) => acc + item.custoTotal, 0);
                
                const novaFicha = {
                    type: tipo,
                    header: header,
                    componentes: fichaAtual.componentes,
                    custoTotal
                };

                if (fichaAtual.id) {
                    await setDoc(doc(db, getCollectionPath('recipes'), fichaAtual.id), novaFicha);
                    alert(`Ficha "${header.descricaoProduto}" atualizada com sucesso!`);
                } else {
                    await addDoc(collection(db, getCollectionPath('recipes')), novaFicha);
                    alert(`Ficha "${header.descricaoProduto}" salva como ${tipo} com sucesso!`);
                }
                
                limparFicha();
            }

            function gerarPDF(fichaId, incluirCustos) {
                const { jsPDF } = window.jspdf;
                const ficha = receitasSalvas.find(f => f.id == fichaId);
                if (!ficha) return;

                const doc = new jsPDF();
                
                doc.setFontSize(22);
                doc.text("Ficha Técnica Gerencial", 105, 20, null, null, "center");
                
                doc.setFontSize(12);
                doc.text(`Prato: ${ficha.header.descricaoProduto}`, 14, 40);
                doc.text(`Categoria: ${ficha.header.categoria || ''}`, 14, 47);
                doc.text(`Rendimento da Receita: ${ficha.header.rendimentoReceitaKg || 0} kg`, 14, 54);
                doc.text(`Tamanho da Porção: ${ficha.header.tamanhoPorcaoG || 0} g`, 14, 61);

                const tableColumn = incluirCustos
                    ? ["Item", "Unid.", "Qtd. Liq.", "FC", "Qtd. Bruta", "Custo Unit.", "Custo Total"]
                    : ["Item", "Unid.", "Qtd. Liq.", "FC", "Qtd. Bruta"];
                const tableRows = [];

                ficha.componentes.forEach(item => {
                    const itemData = incluirCustos
                        ? [ item.nome, item.unidade, item.qtdeLiquida.toFixed(3), item.fatorCorrecao.toFixed(3), item.qtdeBruta.toFixed(3), `R$ ${item.custoUnitario.toFixed(2)}`, `R$ ${item.custoTotal.toFixed(2)}` ]
                        : [ item.nome, item.unidade, item.qtdeLiquida.toFixed(3), item.fatorCorrecao.toFixed(3), item.qtdeBruta.toFixed(3) ];
                    tableRows.push(itemData);
                });

                doc.autoTable(tableColumn, tableRows, { startY: 70 });
                let finalY = doc.lastAutoTable.finalY || 80;

                doc.setFontSize(14);
                doc.text("Modo de Preparo:", 14, finalY + 10);
                doc.setFontSize(10);
                const splitPreparo = doc.splitTextToSize(ficha.header.modoPreparo || 'Nenhum modo de preparo cadastrado.', 180);
                doc.text(splitPreparo, 14, finalY + 16);
                finalY = finalY + 16 + (splitPreparo.length * 4);

                if (incluirCustos) {
                    doc.setFontSize(14);
                    doc.text("Resumo de Custos:", 14, finalY + 10);
                    const custoPorKg = (ficha.custoTotal / ficha.header.rendimentoReceitaKg) || 0;
                    const custoPorPorcao = custoPorKg * (ficha.header.tamanhoPorcaoG / 1000) || 0;
                    doc.setFontSize(12);
                    doc.text(`Custo Total da Ficha: R$ ${ficha.custoTotal.toFixed(2)}`, 14, finalY + 17);
                    doc.text(`Custo por Kg: R$ ${custoPorKg.toFixed(2)}`, 14, finalY + 24);
                    doc.text(`Custo por Porção: R$ ${custoPorPorcao.toFixed(2)}`, 14, finalY + 31);
                }

                const tipoFicha = incluirCustos ? "Custo" : "Operacional";
                doc.save(`Ficha_${tipoFicha}_${ficha.header.descricaoProduto.replace(/ /g,"_")}.pdf`);
            }
            
            async function callGeminiForRecipe() {
                const button = btnAssistenteReceita;
                const loader = button.querySelector('.loader');
                const buttonText = button.querySelector('span:last-child');
                
                if (fichaAtual.componentes.length === 0) {
                    alert("Adicione pelo menos um ingrediente à ficha antes de usar o assistente.");
                    return;
                }

                loader.classList.remove('hidden');
                buttonText.textContent = 'Gerando...';
                button.disabled = true;

                const ingredientNames = fichaAtual.componentes.map(c => c.nome).join(', ');
                const prompt = `Baseado nos seguintes ingredientes: ${ingredientNames}, crie uma receita. Forneça uma resposta em formato JSON com as chaves "recipeName" (string), "category" (string), e "preparationSteps" (string com parágrafos separados por '\\n').`;
                
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content.parts[0].text) {
                        const textResponse = result.candidates[0].content.parts[0].text;
                        const jsonResponse = JSON.parse(textResponse);
                        
                        document.getElementById('descricao-produto').value = (jsonResponse.recipeName || '').toUpperCase();
                        categoriaProdutoSelect.value = (jsonResponse.category || '').toUpperCase();
                        document.getElementById('modo-preparo').value = (jsonResponse.preparationSteps || '').toUpperCase();
                    } else {
                        throw new Error("Resposta da API inválida.");
                    }
                } catch (error) {
                    console.error("Erro ao chamar a API Gemini:", error);
                    alert("Ocorreu um erro ao gerar a receita. Tente novamente.");
                } finally {
                    loader.classList.add('hidden');
                    buttonText.textContent = '✨ Assistente';
                    button.disabled = false;
                }
            }

            // --- WEB SPEECH API ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.lang = 'pt-BR';
                recognition.interimResults = true;

                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                    modoPreparoTextarea.value += finalTranscript.toUpperCase();
                };

                recognition.onend = () => {
                    btnVoiceToText.classList.remove('mic-active');
                };
            } else {
                console.log("Reconhecimento de voz não é suportado neste navegador.");
                btnVoiceToText.style.display = 'none';
            }

            // --- FUNÇÕES DE ANÁLISE DE VENDAS ---
            function simularVendas() {
                const pratos = receitasSalvas.filter(r => r.type === 'prato');
                return pratos.map(prato => {
                    const popularidade = prato.header.descricaoProduto.includes('PARMEGIANA') || prato.header.descricaoProduto.includes('PF') ? 5 : 1;
                    const aleatoriedade = Math.random() * 50 + 10;
                    const quantidade = Math.floor(aleatoriedade * popularidade);
                    return {
                        id: prato.id,
                        nome: prato.header.descricaoProduto,
                        quantidadeVendida: quantidade,
                        precoVenda: prato.header.precoVenda,
                        custoPorcao: (prato.custoTotal / prato.header.rendimentoReceitaKg) * (prato.header.tamanhoPorcaoG / 1000) || 0,
                    };
                });
            }

            function calcularDadosVendas() {
                const vendasSimuladas = simularVendas();
                return vendasSimuladas.map(venda => {
                    const receitaTotal = venda.precoVenda * venda.quantidadeVendida;
                    const cmvTotal = venda.custoPorcao * venda.quantidadeVendida;
                    const lucroBruto = receitaTotal - cmvTotal;
                    const cmvPercentual = receitaTotal > 0 ? (cmvTotal / receitaTotal) * 100 : 0;
                    const margemContribuicao = receitaTotal > 0 ? (lucroBruto / receitaTotal) * 100 : 0;
                    return { ...venda, receitaTotal, cmvTotal, lucroBruto, cmvPercentual, margemContribuicao };
                });
            }

            function renderizarDesempenhoCMV(dadosVendas) {
                let tableHTML = `
                    <table class="min-w-full divide-y divide-border-color text-sm">
                        <thead class="table-header">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Prato</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Qtd.</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Receita</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Custo/Porção</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">CMV Total</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Lucro Bruto</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">CMV (%)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Margem (%)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-border-color">
                `;
                dadosVendas.forEach(item => {
                    tableHTML += `
                        <tr class="table-row">
                            <td class="px-4 py-2 whitespace-nowrap font-medium">${item.nome}</td>
                            <td class="px-4 py-2 whitespace-nowrap">${item.quantidadeVendida}</td>
                            <td class="px-4 py-2 whitespace-nowrap">R$ ${item.receitaTotal.toFixed(2)}</td>
                            <td class="px-4 py-2 whitespace-nowrap">R$ ${item.custoPorcao.toFixed(2)}</td>
                            <td class="px-4 py-2 whitespace-nowrap">R$ ${item.cmvTotal.toFixed(2)}</td>
                            <td class="px-4 py-2 whitespace-nowrap font-semibold text-green-600">R$ ${item.lucroBruto.toFixed(2)}</td>
                            <td class="px-4 py-2 whitespace-nowrap">${item.cmvPercentual.toFixed(2)}%</td>
                            <td class="px-4 py-2 whitespace-nowrap font-semibold text-blue-600">${item.margemContribuicao.toFixed(2)}%</td>
                        </tr>
                    `;
                });
                tableHTML += '</tbody></table>';
                desempenhoCmvContainer.innerHTML = tableHTML;
            }
            
            function renderizarEngenhariaCardapio(dadosVendas) {
                const totalVendido = dadosVendas.reduce((sum, item) => sum + item.quantidadeVendida, 0);
                const mediaPopularidade = totalVendido / dadosVendas.length;
                const mediaLucratividade = dadosVendas.reduce((sum, item) => sum + (item.precoVenda - item.custoPorcao), 0) / dadosVendas.length;
                
                const classificacao = { estrelas: [], burrosDeCarga: [], quebraCabecas: [], caes: [] };

                dadosVendas.forEach(item => {
                    const popularidade = item.quantidadeVendida;
                    const lucratividade = item.precoVenda - item.custoPorcao;
                    if (popularidade >= mediaPopularidade && lucratividade >= mediaLucratividade) classificacao.estrelas.push(item);
                    else if (popularidade >= mediaPopularidade && lucratividade < mediaLucratividade) classificacao.burrosDeCarga.push(item);
                    else if (popularidade < mediaPopularidade && lucratividade >= mediaLucratividade) classificacao.quebraCabecas.push(item);
                    else classificacao.caes.push(item);
                });

                const renderQuadrante = (titulo, emoji, cor, pratos, acao) => {
                    let pratosHtml = pratos.map(p => `<li class="text-sm text-secondary">${p.nome}</li>`).join('') || `<li class="text-sm text-secondary">Nenhum prato aqui.</li>`;
                    return `
                        <div class="bg-bg-secondary p-4 rounded-lg border-l-4 shadow-sm" style="border-color:${cor}">
                            <h4 class="text-lg font-bold mb-2">${emoji} ${titulo}</h4>
                            <p class="text-xs text-secondary mb-3">${acao}</p>
                            <ul class="list-disc list-inside space-y-1">${pratosHtml}</ul>
                        </div>`;
                };

                engenhariaCardapioContainer.innerHTML = `
                    ${renderQuadrante('ESTRELAS', '⭐', '#10b981', classificacao.estrelas, 'Mantenha a qualidade, destaque no cardápio e nunca os tire de linha.')}
                    ${renderQuadrante('BURROS DE CARGA', '🐴', '#f59e0b', classificacao.burrosDeCarga, 'Otimize a ficha técnica para reduzir o custo ou considere um pequeno aumento de preço.')}
                    ${renderQuadrante('QUEBRA-CABEÇAS', '❓', '#3b82f6', classificacao.quebraCabecas, 'Promova-os, sugira aos clientes, crie combos, melhore a descrição ou a foto.')}
                    ${renderQuadrante('CÃES', '🐶', '#ef4444', classificacao.caes, 'Considere seriamente reformular a receita ou removê-los do cardápio.')}
                `;
            }
            
            function renderizarCurvaABC(dadosVendas) {
                const totalLucroBruto = dadosVendas.reduce((sum, item) => sum + item.lucroBruto, 0);
                const pratosOrdenados = [...dadosVendas].sort((a, b) => b.lucroBruto - a.lucroBruto);

                const classificacao = { A: [], B: [], C: [] };
                let lucroAcumulado = 0;

                pratosOrdenados.forEach(item => {
                    lucroAcumulado += item.lucroBruto;
                    const percentualAcumulado = (lucroAcumulado / totalLucroBruto) * 100;
                    const itemComPercentual = { ...item, percentualIndividual: (item.lucroBruto / totalLucroBruto) * 100, percentualAcumulado };
                    if (percentualAcumulado <= 70) classificacao.A.push(itemComPercentual);
                    else if (percentualAcumulado <= 90) classificacao.B.push(itemComPercentual);
                    else classificacao.C.push(itemComPercentual);
                });

                const renderCurva = (titulo, cor, pratos) => {
                    let pratosHtml = pratos.map(p => `
                        <div class="grid grid-cols-3 gap-2 text-sm">
                            <span>${p.nome}</span>
                            <span class="text-right text-secondary">R$ ${p.lucroBruto.toFixed(2)}</span>
                            <span class="text-right font-semibold">${p.percentualIndividual.toFixed(2)}%</span>
                        </div>`).join('') || `<p class="text-sm text-secondary">Nenhum prato aqui.</p>`;
                    return `
                        <div class="bg-bg-secondary p-4 rounded-lg shadow-sm">
                            <h4 class="text-lg font-bold mb-2" style="color:${cor}">Curva ${titulo}</h4>
                            <div class="space-y-1">${pratosHtml}</div>
                        </div>`;
                };

                curvaAbcContainer.innerHTML = `
                    ${renderCurva('A', '#10b981', classificacao.A)}
                    ${renderCurva('B', '#f59e0b', classificacao.B)}
                    ${renderCurva('C', '#ef4444', classificacao.C)}
                `;
            }

            // --- EVENT LISTENERS ---
            formIngrediente.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const precoCompra = parseFloat(form['preco-compra'].value);
                const unidadeCompraQtd = parseFloat(form['unidade-compra-qtd'].value);
                if (!precoCompra || !unidadeCompraQtd || unidadeCompraQtd <= 0) { alert("Preço e quantidade da compra devem ser valores válidos e positivos."); return; }
                const newIngredient = {
                    nome: form['nome-ingrediente'].value.toUpperCase(), 
                    category: form['categoria-ingrediente'].value, 
                    precoCompra, 
                    unidadeCompraDesc: form['unidade-compra-desc'].value, 
                    unidadeCompraQtd, 
                    unidadeBase: form['unidade-base'].value, 
                    rendimento: parseFloat(form['rendimento-ingrediente'].value), 
                    custoBase: precoCompra / unidadeCompraQtd
                };
                try {
                    await addDoc(collection(db, getCollectionPath('ingredients')), newIngredient);
                    alert('Ingrediente salvo com sucesso!');
                    form.reset();
                    form['rendimento-ingrediente'].value = '100';
                } catch (error) {
                    console.error("Erro ao salvar ingrediente:", error);
                    alert(`Falha ao salvar ingrediente: ${error.message}`);
                }
            });

            formProdutoVenda.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const newProduct = {
                    nome: form['nome-produto-venda'].value.toUpperCase(),
                    category: form['categoria-produto-venda'].value,
                    precoCompra: parseFloat(form['preco-compra-venda'].value),
                    precoVenda: parseFloat(form['preco-venda-venda'].value),
                    taxaPerda: parseFloat(form['taxa-perda-venda'].value) || 0
                };
                 try {
                    await addDoc(collection(db, getCollectionPath('direct_sale_products')), newProduct);
                    alert('Produto salvo com sucesso!');
                    form.reset();
                } catch (error) {
                    console.error("Erro ao salvar produto:", error);
                    alert(`Falha ao salvar produto: ${error.message}`);
                }
            });

            selectItem.addEventListener('change', (e) => {
                const selectedValue = e.target.value;
                if (selectedValue.startsWith('ing_')) {
                    const [_, id] = selectedValue.split('_');
                    const ing = ingredientes.find(i => i.id == id);
                    const fatorCorrecaoPadrao = 1 / (ing.rendimento / 100);
                    fatorCorrecaoOverrideInput.value = fatorCorrecaoPadrao.toFixed(3);
                    fatorCorrecaoOverrideInput.disabled = false;
                } else {
                    fatorCorrecaoOverrideInput.value = '';
                    fatorCorrecaoOverrideInput.placeholder = 'N/A';
                    fatorCorrecaoOverrideInput.disabled = true;
                fatorCorrecaoOverrideInput.placeholder = 'Padrão';
            });

            function handlePhotoFile(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!file.type.startsWith('image/')) {
                    alert('Por favor, selecione um ficheiro de imagem.');
                    return;
                }

                if (file.size > 1024 * 1024) { // 1MB size limit
                    alert('A imagem é muito grande (máx 1MB). Por favor, use uma imagem menor.');
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    fotoPreview.src = e.target.result;
                    fotoUrlInput.value = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            btnCarregarFoto.addEventListener('click', () => {
                document.getElementById('input-foto').click();
            });
            document.getElementById('input-foto').addEventListener('change', handlePhotoFile);

            btnAssistenteReceita.addEventListener('click', callGeminiForRecipe);
            btnSalvarReceita.addEventListener('click', () => salvarFicha('base'));
            btnSalvarPrato.addEventListener('click', () => salvarFicha('prato'));
            btnNovaFicha.addEventListener('click', limparFicha);
            inputMarkupPrato.addEventListener('input', calcularCustosFinais);
            rendimentoReceitaKgInput.addEventListener('input', calcularCustosFinais);
            tamanhoPorcaoGInput.addEventListener('input', calcularCustosFinais);
            
            // --- LÓGICA DE IMPORTAÇÃO DE INGREDIENTES ---
            btnImportarIngredientes.addEventListener('click', () => {
                importModal.classList.remove('hidden');
                importModal.classList.add('flex');
                importStep1.classList.remove('hidden');
                importStep2.classList.add('hidden');
                btnLoadForEdit.classList.remove('hidden');
                btnSaveImport.classList.add('hidden');
                importTextarea.value = '';
                importEditTableBody.innerHTML = '';
            });

            const closeModal = () => {
                importModal.classList.add('hidden');
                importModal.classList.remove('flex');
            };

            btnCloseModal.addEventListener('click', closeModal);
            btnCancelImport.addEventListener('click', closeModal);

            btnLoadForEdit.addEventListener('click', () => {
                const data = importTextarea.value.trim();
                const lines = data.split('\n');
                importEditTableBody.innerHTML = '';
                let hasContent = false;

                lines.forEach((line, index) => {
                    if (line.trim() === '') return;
                    const parts = line.split('\t');
                    
                    let nome = '', preco = '', qtd = '', unidade = '', categoria = '';

                    if (parts.length >= 5) { // Formato completo
                        [nome, preco, qtd, unidade, categoria] = parts;
                    } else if (parts.length >= 3) { // Formato básico
                        [nome, unidade, categoria] = parts;
                    } else if (parts.length >= 1 && parts[0].trim() !== '') { // Formato mínimo
                        [nome] = parts;
                    }
                    else {
                        return; // Ignora linhas mal formatadas
                    }
                    
                    hasContent = true;
                    const tr = document.createElement('tr');
                    tr.className = 'table-row';
                    tr.innerHTML = `
                        <td class="px-2 py-1"><input type="text" value="${nome.trim().toUpperCase()}" class="form-input text-sm p-1 import-nome"></td>
                        <td class="px-2 py-1"><input type="number" step="0.01" value="${preco.trim().replace(',', '.')}" placeholder="0.00" class="form-input text-sm p-1 import-preco"></td>
                        <td class="px-2 py-1"><input type="number" step="0.001" value="${qtd.trim().replace(',', '.')}" placeholder="0.000" class="form-input text-sm p-1 import-qtd"></td>
                        <td class="px-2 py-1"><input type="text" value="${unidade.trim()}" class="form-input text-sm p-1 import-unidade"></td>
                        <td class="px-2 py-1"><input type="text" value="${categoria.trim().toUpperCase()}" class="form-input text-sm p-1 import-categoria"></td>
                    `;
                    importEditTableBody.appendChild(tr);
                });

                if (hasContent) {
                    importStep1.classList.add('hidden');
                    importStep2.classList.remove('hidden');
                    btnLoadForEdit.classList.add('hidden');
                    btnSaveImport.classList.remove('hidden');
                } else {
                    alert('Nenhum dado válido encontrado. Verifique o formato e tente novamente.');
                }
            });

            btnSaveImport.addEventListener('click', async () => {
                const button = btnSaveImport;
                const btnText = button.querySelector('.btn-text');
                const loader = button.querySelector('.loader');

                btnText.classList.add('hidden');
                loader.classList.remove('hidden');
                button.disabled = true;

                const rows = importEditTableBody.querySelectorAll('tr');
                const promises = [];
                let successCount = 0;
                let errorCount = 0;

                rows.forEach(row => {
                    try {
                        const nome = row.querySelector('.import-nome').value;
                        const precoCompra = parseFloat(row.querySelector('.import-preco').value);
                        const unidadeCompraQtd = parseFloat(row.querySelector('.import-qtd').value);
                        const unidadeBase = row.querySelector('.import-unidade').value;
                        const category = row.querySelector('.import-categoria').value;

                        if (!nome || isNaN(precoCompra) || isNaN(unidadeCompraQtd) || unidadeCompraQtd <= 0 || !unidadeBase || !category) {
                            errorCount++;
                            console.error("Linha com dados inválidos/incompletos:", {nome, precoCompra, unidadeCompraQtd, unidadeBase, category});
                            return;
                        }

                        const newIngredient = {
                            nome,
                            precoCompra,
                            unidadeCompraQtd,
                            unidadeBase,
                            category,
                            unidadeCompraDesc: 'EMBALAGEM',
                            rendimento: 100,
                            custoBase: precoCompra / unidadeCompraQtd
                        };

                        promises.push(addDoc(collection(db, getCollectionPath('ingredients')), newIngredient));
                        successCount++;

                    } catch (e) {
                        errorCount++;
                        console.error('Erro ao processar linha da tabela de importação', e);
                    }
                });

                try {
                    await Promise.all(promises);
                    alert(`${successCount} ingredientes importados com sucesso! ${errorCount > 0 ? `\n${errorCount} linhas continham erros e foram ignoradas.` : ''}`);
                    closeModal();
                } catch (error) {
                    console.error("Erro ao salvar ingredientes no Firebase:", error);
                    alert("Ocorreu um erro ao salvar os dados. Verifique a consola para mais detalhes.");
                } finally {
                    btnText.classList.remove('hidden');
                    loader.classList.add('hidden');
                    button.disabled = false;
                }
            });

            // --- LÓGICA DE EDIÇÃO DE INGREDIENTES ---
            function openEditIngredientModal(ingredientId) {
                const ing = ingredientes.find(i => i.id === ingredientId);
                if (!ing) return;

                const select = document.getElementById('edit-categoria-ingrediente');
                select.innerHTML = '';
                ingredientCategories.forEach(cat => {
                    select.innerHTML += `<option value="${cat}">${cat}</option>`;
                });

                document.getElementById('edit-ingrediente-id').value = ing.id;
                document.getElementById('edit-nome-ingrediente').value = ing.nome;
                select.value = ing.category;
                document.getElementById('edit-preco-compra').value = ing.precoCompra;
                document.getElementById('edit-unidade-compra-desc').value = ing.unidadeCompraDesc;
                document.getElementById('edit-unidade-compra-qtd').value = ing.unidadeCompraQtd;
                document.getElementById('edit-unidade-base').value = ing.unidadeBase;
                document.getElementById('edit-rendimento-ingrediente').value = ing.rendimento;
                
                btnDeleteIngrediente.textContent = 'Excluir Ingrediente';
                btnDeleteIngrediente.dataset.confirmed = 'false';

                editIngredientModal.classList.remove('hidden');
                editIngredientModal.classList.add('flex');
            }

            function closeEditIngredientModal() {
                editIngredientModal.classList.add('hidden');
                editIngredientModal.classList.remove('flex');
            }

            listaIngredientesDiv.addEventListener('dblclick', (e) => {
                const li = e.target.closest('li[data-id]');
                if (li) {
                    openEditIngredientModal(li.dataset.id);
                }
            });

            btnCloseEditModal.addEventListener('click', closeEditIngredientModal);

            formEditIngrediente.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('edit-ingrediente-id').value;
                const precoCompra = parseFloat(document.getElementById('edit-preco-compra').value);
                const unidadeCompraQtd = parseFloat(document.getElementById('edit-unidade-compra-qtd').value);

                const updatedIngredient = {
                    nome: document.getElementById('edit-nome-ingrediente').value.toUpperCase(),
                    category: document.getElementById('edit-categoria-ingrediente').value,
                    precoCompra,
                    unidadeCompraDesc: document.getElementById('edit-unidade-compra-desc').value,
                    unidadeCompraQtd,
                    unidadeBase: document.getElementById('edit-unidade-base').value,
                    rendimento: parseFloat(document.getElementById('edit-rendimento-ingrediente').value),
                    custoBase: precoCompra / unidadeCompraQtd
                };
                
                const ingredientRef = doc(db, getCollectionPath('ingredients'), id);
                await updateDoc(ingredientRef, updatedIngredient);
                alert('Ingrediente atualizado com sucesso!');
                closeEditIngredientModal();
            });

            btnDeleteIngrediente.addEventListener('click', async () => {
                if (btnDeleteIngrediente.dataset.confirmed === 'true') {
                    const id = document.getElementById('edit-ingrediente-id').value;
                    await deleteDoc(doc(db, getCollectionPath('ingredients'), id));
                    alert('Ingrediente excluído com sucesso!');
                    closeEditIngredientModal();
                } else {
                    btnDeleteIngrediente.textContent = 'CONFIRMAR EXCLUSÃO?';
                    btnDeleteIngrediente.dataset.confirmed = 'true';
                    setTimeout(() => {
                         btnDeleteIngrediente.textContent = 'Excluir Ingrediente';
                         btnDeleteIngrediente.dataset.confirmed = 'false';
                    }, 3000); 
                }
            });

            // --- LÓGICA DE IMPORTAÇÃO DE FICHAS (NOVO) ---
            async function callGeminiForRecipeImport() {
                const button = btnProcessRecipeImport;
                const loader = button.querySelector('.loader');
                const buttonText = button.querySelector('.btn-text');
                const recipeText = importRecipeTextarea.value;

                if (!recipeText.trim()) {
                    alert("Por favor, cole o texto da sua ficha técnica na área indicada.");
                    return;
                }

                loader.classList.remove('hidden');
                buttonText.textContent = 'Analisando...';
                button.disabled = true;

                const prompt = `
                    Analise o seguinte texto de uma ficha técnica e extraia as informações em um formato JSON ESTRITO.

                    O JSON de saída DEVE ter a seguinte estrutura:
                    {
                      "recipeName": "string",
                      "category": "string",
                      "ingredients": [
                        {
                          "name": "string",
                          "quantity": number,
                          "unit": "string"
                        }
                      ],
                      "preparationSteps": "string"
                    }

                    Regras importantes:
                    1.  NÃO invente dados. Se uma informação não for encontrada, retorne um valor vazio ("") ou um array vazio ([]).
                    2.  Normalize as unidades para abreviações comuns (ex: 'gramas' -> 'g', 'quilos' -> 'kg', 'litros' -> 'l', 'mililitros' -> 'ml', 'unidades' -> 'un').
                    3.  O nome do ingrediente deve ser o mais limpo possível.

                    Texto da Ficha para análise:
                    ---
                    ${recipeText}
                    ---
                `;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                    }
                };
                const apiKey = ""; // Será preenchido pelo ambiente
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (result.candidates && result.candidates[0].content.parts[0].text) {
                        const textResponse = result.candidates[0].content.parts[0].text;
                        const jsonResponse = JSON.parse(textResponse);
                        
                        limparFicha();
                        
                        document.getElementById('descricao-produto').value = (jsonResponse.recipeName || '').toUpperCase();
                        document.getElementById('modo-preparo').value = (jsonResponse.preparationSteps || '').toUpperCase();
                        
                        const foundCategory = dishCategories.find(c => c.toUpperCase() === (jsonResponse.category || '').toUpperCase());
                        if (foundCategory) {
                            document.getElementById('categoria-produto').value = foundCategory;
                        }

                        let notFoundIngredients = [];
                        let conversionErrors = [];

                        jsonResponse.ingredients.forEach(aiIngredient => {
                            const dbIngredient = ingredientes.find(ing => ing.nome.toUpperCase() === aiIngredient.name.toUpperCase());
                            
                            if (dbIngredient) {
                                let qtdeLiquida = parseFloat(aiIngredient.quantity);
                                if (isNaN(qtdeLiquida)) {
                                    conversionErrors.push(aiIngredient.name);
                                    return;
                                }

                                const fatorCorrecao = 1 / (dbIngredient.rendimento / 100);
                                const qtdeBruta = qtdeLiquida * fatorCorrecao;
                                const itemParaFicha = {
                                    type: 'ing',
                                    nome: dbIngredient.nome,
                                    unidade: dbIngredient.unidadeBase,
                                    qtdeLiquida,
                                    fatorCorrecao,
                                    qtdeBruta,
                                    custoUnitario: dbIngredient.custoBase,
                                    custoTotal: qtdeBruta * dbIngredient.custoBase
                                };
                                fichaAtual.componentes.push(itemParaFicha);
                            } else {
                                notFoundIngredients.push(aiIngredient.name);
                            }
                        });

                        renderizarFichaAtual();
                        showView('fichas');
                        importRecipeModal.classList.add('hidden');
                        
                        let finalMessage = "Ficha importada com sucesso!";
                        if (notFoundIngredients.length > 0) {
                            finalMessage += `\n\nAtenção: Os seguintes ingredientes não foram encontrados no seu banco de dados e não foram adicionados: ${notFoundIngredients.join(', ')}. Verifique se os nomes correspondem exatamente.`;
                        }
                        if (conversionErrors.length > 0) {
                             finalMessage += `\n\nErro: Não foi possível converter a quantidade para os seguintes ingredientes: ${conversionErrors.join(', ')}.`;
                        }
                        alert(finalMessage);

                    } else {
                        console.error("Resposta da API Gemini não continha o texto esperado:", result);
                        throw new Error("Resposta da API inválida ou vazia.");
                    }
                } catch (error) {
                    console.error("Erro ao importar ficha com IA:", error);
                    alert("Ocorreu um erro ao processar a ficha. Verifique o formato do texto ou tente novamente. Detalhes: " + error.message);
                } finally {
                    loader.classList.add('hidden');
                    buttonText.textContent = '✨ Analisar Ficha com IA';
                    button.disabled = false;
                }
            }
            
            btnImportarFicha.addEventListener('click', () => {
                importRecipeModal.classList.remove('hidden');
                importRecipeModal.classList.add('flex');
                importRecipeTextarea.value = '';
            });

            const closeRecipeModal = () => {
                importRecipeModal.classList.add('hidden');
                importRecipeModal.classList.remove('flex');
            }

            btnCloseRecipeModal.addEventListener('click', closeRecipeModal);
            btnCancelRecipeImport.addEventListener('click', closeRecipeModal);
            btnProcessRecipeImport.addEventListener('click', callGeminiForRecipeImport);

            // --- LÓGICA DE ATUALIZAÇÃO DE PREÇOS ---
            btnAbrirAtualizarPrecos.addEventListener('click', () => {
                formAtualizarPrecos.innerHTML = '';
                ingredientes.forEach(ing => {
                    const div = document.createElement('div');
                    div.className = 'grid grid-cols-3 gap-2 items-center';
                    div.innerHTML = `
                        <label for="preco-update-${ing.id}" class="col-span-2 text-sm text-secondary">${ing.nome}</label>
                        <input type="number" step="0.01" id="preco-update-${ing.id}" data-id="${ing.id}" value="${ing.precoCompra.toFixed(2)}" class="form-input text-sm">
                    `;
                    formAtualizarPrecos.appendChild(div);
                });
                painelAtualizarPrecos.classList.remove('hidden');
            });

            btnCancelarAtualizacao.addEventListener('click', () => {
                painelAtualizarPrecos.classList.add('hidden');
            });

            btnSalvarNovosPrecos.addEventListener('click', async () => {
                const button = btnSalvarNovosPrecos;
                const btnText = button.querySelector('.btn-text');
                const loader = button.querySelector('.loader');
                btnText.classList.add('hidden');
                loader.classList.remove('hidden');
                button.disabled = true;

                try {
                    const recipeCostsBeforeUpdate = receitasSalvas.map(recipe => ({
                        id: recipe.id,
                        header: { descricaoProduto: recipe.header.descricaoProduto },
                        type: recipe.type,
                        custoTotal: recalcularCustoFicha(recipe, ingredientes)
                    }));

                    const historyEntry = {
                        date: new Date().toISOString(),
                        recipeCosts: recipeCostsBeforeUpdate
                    };

                    const inputs = formAtualizarPrecos.querySelectorAll('input[type="number"]');
                    const updatePromises = [];

                    inputs.forEach(input => {
                        const ingredientId = input.dataset.id;
                        const newPrice = parseFloat(input.value);
                        const ingredient = ingredientes.find(ing => ing.id === ingredientId);

                        if (ingredient && !isNaN(newPrice) && newPrice > 0 && newPrice !== ingredient.precoCompra) {
                            const newCustoBase = newPrice / ingredient.unidadeCompraQtd;
                            const ingredientRef = doc(db, getCollectionPath('ingredients'), ingredientId);
                            updatePromises.push(updateDoc(ingredientRef, {
                                precoCompra: newPrice,
                                custoBase: newCustoBase
                            }));
                        }
                    });

                    if (updatePromises.length > 0 && recipeCostsBeforeUpdate.length > 0) {
                        updatePromises.push(addDoc(collection(db, getCollectionPath('price_history')), historyEntry));
                    }

                    if (updatePromises.length > 0) {
                        await Promise.all(updatePromises);
                        alert('Preços e histórico de custos atualizados com sucesso!');
                    } else {
                        alert('Nenhum preço foi alterado.');
                    }
                    
                    painelAtualizarPrecos.classList.add('hidden');

                } catch (error) {
                    console.error("Erro ao atualizar preços:", error);
                    alert(`Falha ao atualizar preços: ${error.message}`);
                } finally {
                    btnText.classList.remove('hidden');
                    loader.classList.add('hidden');
                    button.disabled = false;
                }
            });
            
            let isRecognizing = false;
            btnVoiceToText.addEventListener('click', () => {
                if(!micToggle.checked) {
                    alert('O microfone está desabilitado nas configurações.');
                    return;
                }
                if (recognition) {
                    if (isRecognizing) {
                        recognition.stop();
                        isRecognizing = false;
                        btnVoiceToText.classList.remove('mic-active');
                    } else {
                        recognition.start();
                        isRecognizing = true;
                        btnVoiceToText.classList.add('mic-active');
                    }
                }
            });

            searchAnaliseInput.addEventListener('input', (e) => renderizarAnaliseDeCustos(e.target.value, filterAnaliseSelect.value));
            filterAnaliseSelect.addEventListener('change', (e) => renderizarAnaliseDeCustos(searchAnaliseInput.value, e.target.value));

            btnSalvarListaPrecos.addEventListener('click', async () => {
                const inputs = listaPrecosContainer.querySelectorAll('.novo-preco-input');
                const updatePromises = [];
                inputs.forEach(input => {
                    const itemDiv = input.closest('.prato-item');
                    const itemId = itemDiv.dataset.id;
                    const itemType = itemDiv.dataset.type;
                    const novoPreco = parseFloat(input.value);

                    if (itemType === 'prato') {
                        const itemRef = doc(db, getCollectionPath('recipes'), itemId);
                        updatePromises.push(updateDoc(itemRef, { "header.precoVenda": novoPreco }));
                    } else if (itemType === 'produto') {
                        const itemRef = doc(db, getCollectionPath('direct_sale_products'), itemId);
                        updatePromises.push(updateDoc(itemRef, { precoVenda: novoPreco }));
                    }
                });
                await Promise.all(updatePromises);
                alert('Preços de venda atualizados com sucesso!');
                showView('dashboard');
            });

            function atualizarNovaMargem(e) {
                const input = e.target;
                const pratoItemDiv = input.closest('.prato-item');
                const custo = parseFloat(pratoItemDiv.dataset.custo);
                const novoPreco = parseFloat(input.value) || 0;
                const novaMargemSpan = pratoItemDiv.querySelector('.nova-margem-span');
                
                const margemReais = novoPreco - custo;
                const novaMargemPercent = novoPreco > 0 ? (margemReais / novoPreco) * 100 : 0;
                
                novaMargemSpan.textContent = `${novaMargemPercent.toFixed(2)}%`;
                novaMargemSpan.style.color = margemReais > 0 ? '#10b981' : '#ef4444';
            }

            function aplicarMargemCategoria(e) {
                const button = e.target;
                const categoryDiv = button.closest('[data-category]');
                const margemInput = categoryDiv.querySelector('input[type="number"]');
                const novaMargem = parseFloat(margemInput.value);

                if (isNaN(novaMargem)) { alert('Por favor, insira um valor de margem válido.'); return; }

                const pratosDaCategoria = categoryDiv.querySelectorAll('.prato-item');
                pratosDaCategoria.forEach(pratoDiv => {
                    const custo = parseFloat(pratoDiv.dataset.custo);
                    const novoPreco = custo / (1 - (novaMargem / 100));
                    const precoInput = pratoDiv.querySelector('.novo-preco-input');
                    precoInput.value = novoPreco.toFixed(2);
                    precoInput.dispatchEvent(new Event('input'));
                });

                const originalText = button.textContent;
                button.textContent = 'Aplicado!';
                button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                button.classList.add('bg-green-600');
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    button.classList.remove('bg-green-600');
                    margemInput.value = '';
                }, 2000);
            }

            btnImportarVendas.addEventListener('click', () => {
                const dadosVendas = calcularDadosVendas();
                if (dadosVendas.length === 0) { alert("Não há pratos para analisar. Cadastre pratos finais primeiro."); return; }
                renderizarDesempenhoCMV(dadosVendas);
                renderizarEngenhariaCardapio(dadosVendas);
                renderizarCurvaABC(dadosVendas);
                relatoriosVendasContainer.classList.remove('hidden');
            });
            
            // --- EVENT LISTENERS DE CATEGORIA E CONFIGURAÇÕES ---
            formCatIngrediente.addEventListener('submit', (e) => addCategory(e, ingredientCategories, 'nome-cat-ingrediente'));
            formCatPrato.addEventListener('submit', (e) => addCategory(e, dishCategories, 'nome-cat-prato'));
            formCatBase.addEventListener('submit', (e) => addCategory(e, baseRecipeCategories, 'nome-cat-base'));
            formCatVenda.addEventListener('submit', (e) => addCategory(e, directSaleCategories, 'nome-cat-venda'));
            searchIngredienteInput.addEventListener('input', (e) => renderizarIngredientes(e.target.value, filterIngredienteCategoriaSelect.value));
            filterIngredienteCategoriaSelect.addEventListener('change', (e) => renderizarIngredientes(searchIngredienteInput.value, e.target.value));
            
            [listaCatIngredientes, listaCatPratos, listaCatBases, listaCatVenda].forEach(list => {
                list.addEventListener('click', (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;
                    
                    const name = target.dataset.name;
                    const type = target.dataset.type;

                    if (target.classList.contains('btn-delete-cat')) {
                        deleteCategory(name, type);
                    } else if (target.classList.contains('btn-edit-cat')) {
                        editCategory(name, type);
                    }
                });
            });

            themeToggle.addEventListener('change', () => {
                document.body.classList.toggle('dark-theme');
            });

            micToggle.addEventListener('change', () => {
                btnVoiceToText.style.display = micToggle.checked ? 'block' : 'none';
            });
            
            // --- LÓGICA DE AUTENTICAÇÃO ---
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showRegisterBtn = document.getElementById('show-register');
            const showLoginBtn = document.getElementById('show-login');
            const logoutBtn = document.getElementById('logout-btn');

            showRegisterBtn.addEventListener('click', (e) => {
                e.preventDefault();
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            });

            showLoginBtn.addEventListener('click', (e) => {
                e.preventDefault();
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = loginForm['login-email'].value;
                const password = loginForm['login-password'].value;
                const errorP = document.getElementById('login-error');
                const button = loginForm.querySelector('button[type="submit"]');
                const btnText = button.querySelector('.btn-text');
                const loader = button.querySelector('.loader');

                btnText.classList.add('hidden');
                loader.classList.remove('hidden');
                button.disabled = true;

                try {
                    errorP.classList.add('hidden');
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Login failed:", error);
                    errorP.textContent = error.message;
                    errorP.classList.remove('hidden');
                } finally {
                    btnText.classList.remove('hidden');
                    loader.classList.add('hidden');
                    button.disabled = false;
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const restaurantName = registerForm['register-restaurant'].value;
                const email = registerForm['register-email'].value;
                const password = registerForm['register-password'].value;
                const errorP = document.getElementById('register-error');
                const button = registerForm.querySelector('button[type="submit"]');
                const btnText = button.querySelector('.btn-text');
                const loader = button.querySelector('.loader');

                btnText.classList.add('hidden');
                loader.classList.remove('hidden');
                button.disabled = true;

                try {
                    errorP.classList.add('hidden');
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // Criar o documento do restaurante e as categorias iniciais
                    const restaurantDocRef = doc(db, 'restaurants', user.uid);
                    await setDoc(restaurantDocRef, { name: restaurantName, owner: user.uid, createdAt: new Date() });
                    
                    // Definir categorias iniciais para o novo restaurante
                    ingredientCategories = ['CARNES', 'LATICÍNIOS', 'HORTIFRUTI', 'MERCEARIA', 'PEIXES'];
                    dishCategories = ['PRATO PRINCIPAL', 'MASSAS', 'PEIXES', 'EXECUTIVO', 'LANCHES', 'SALADAS', 'SOPAS', 'GRELHADOS', 'ACOMPANHAMENTOS'];
                    baseRecipeCategories = ['MOLHOS', 'ACOMPANHAMENTOS', 'CONSERVAS', 'TEMPEROS'];
                    directSaleCategories = ['REFRIGERANTES', 'CERVEJAS', 'SOBREMESAS'];
                    restaurantId = user.uid; // Definir o ID para a função saveCategories
                    await saveCategories();

                } catch (error) {
                    console.error("Registration failed:", error);
                    errorP.textContent = error.message;
                    errorP.classList.remove('hidden');
                } finally {
                    btnText.classList.remove('hidden');
                    loader.classList.add('hidden');
                    button.disabled = false;
                }
            });

            logoutBtn.addEventListener('click', async () => {
                await signOut(auth);
            });

            // --- INICIALIZAÇÃO DO FIREBASE ---
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        restaurantId = user.uid; // Usamos o UID do user como ID do restaurante
                        console.log("User signed in with UID:", restaurantId);
                        document.getElementById('user-email').textContent = user.email;
                        authView.style.display = 'none';
                        appContainer.style.display = 'flex';
                        setupRealtimeListeners(); 
                        showView('dashboard');
                    } else {
                        restaurantId = null;
                        console.log("No user signed in.");
                        authView.style.display = 'flex';
                        appContainer.style.display = 'none';
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.body.innerHTML = `<div class="text-center p-8 text-red-500">Falha ao conectar com a base de dados: ${error.message}</div>`;
            }
        });
    </script>
    
    <!-- Script para registrar o Service Worker do PWA -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').then(registration => {
            console.log('ServiceWorker registrado com sucesso: ', registration.scope);
          }, err => {
            console.log('Falha ao registrar o ServiceWorker: ', err);
          });
        });
      }
    </script>

</body>
</html>

